<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parlamentní Pořadník</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        html, body { height: 100%; margin: 0; padding: 0; overflow: auto; -webkit-overflow-scrolling: touch; }
        body { font-family: 'Inter', sans-serif; display: flex; flex-direction: column; }
        #app { width: 100%; max-width: 1400px; margin-left: auto; margin-right: auto; padding: 1rem; flex-grow: 1; display: flex; flex-direction: column; min-height: 0; }
        .view { display: none; flex-grow: 1; min-height: 0; }
        .active-view { display: flex; flex-direction: column; min-height: 0; }
        .scrollable-list-container { display: flex; flex-direction: column; min-height: 0; flex-grow: 1; }
        .scrollable-list { overflow-y: auto; flex-grow: 1; }
        .timer-ring { stroke-dasharray: 283; stroke-dashoffset: 283; transition: stroke-dashoffset 0.2s linear; }
        #timer-display { touch-action: none; cursor: grab; }
        input[type="color"] { -webkit-appearance: none; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 1px solid #ccc; border-radius: 8px; }
        .setting-item.dragging { opacity: 0.5; background-color: #e0e7ff; }
        .toggle-checkbox { display: none; }
        .toggle-label { display: block; width: 40px; height: 20px; background-color: #e2e8f0; border-radius: 9999px; position: relative; transition: background-color 0.2s; cursor: pointer; }
        .toggle-label .dot { position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background: white; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .toggle-checkbox:checked + .toggle-label { background-color: #48BB78; }
        .toggle-checkbox:checked + .toggle-label .dot { transform: translateX(20px); }
        .tile.selected { border-color: #3B82F6; box-shadow: 0 0 0 2px #3B82F6; }
        body.fullscreen #main-content { padding: 0; max-width: 100%; height: 100vh; margin-bottom: 0; }
        body.fullscreen #main-header { display: none; }
        body.fullscreen #app { padding: 0; max-width:100%; }
        body.fullscreen #presenter-view { border-radius: 0; height: 100%; }
        #exit-fullscreen-btn { display: none; }
        body.fullscreen #exit-fullscreen-btn { display: block; }
        body.fullscreen #fullscreen-btn { display: none; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; }
        .collapsible-content:not(.hidden) { max-height: none; /* Removed fixed height to prevent cutoff */ }

        /* Mobile/scroll fixes */
        #main-content { overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .view { overflow-y: auto; }
        .active-view { overflow-y: auto; }
        #auth-section { max-height: calc(100vh - 2rem); overflow-y: auto; }
        @media (max-width: 768px) {
          #app { padding: 0.75rem; }
          #presenter-view, #speaker-view, #voting-view, #admin-view { padding: 1rem; }
          #main-header { margin-bottom: 0.75rem; }
          #speaker-view { align-items: stretch !important; justify-content: flex-start !important; }
        }
        @media print {
            body { background-color: white !important; color: black !important; }
            #main-header, .no-print, nav, button, #logout-btn, .nav-btn { display: none !important; }
            #app { max-width: none !important; margin: 0 !important; padding: 0 !important; }
            #main-content { display: block !important; overflow: visible !important; }
            .view { display: none !important; }
            #reports-view { display: block !important; padding: 0 !important; margin: 0 !important; box-shadow: none !important; }
            table { width: 100% !important; border-collapse: collapse !important; }
            th, td { border: 1px solid #e5e7eb !important; padding: 0.5rem !important; text-align: left !important; font-size: 0.875rem !important; }
            thead { background-color: #f9fafb !important; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app">
        <!-- Auth Section -->
        <div id="auth-section" class="text-center p-8 bg-white rounded-lg shadow-md m-auto">
            <h1 class="text-3xl font-bold mb-4">Parlamentní Pořadník</h1>
            <p class="text-gray-600 mb-6">Pro pokračování se prosím přihlaste.</p>
            <button id="login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">
                <i class="fab fa-google mr-2"></i> Přihlásit se Google účtem
            </button>
        </div>

        <!-- Main Content -->
        <div id="main-content" class="hidden flex flex-col flex-grow min-h-0">
            <header id="main-header" class="bg-white rounded-lg shadow-md p-4 mb-4 flex-shrink-0">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div>
                        <h1 class="text-2xl font-bold text-blue-700">Studentský Parlament</h1>
                        <p id="user-info" class="text-xs text-gray-400 font-mono"></p>
                    </div>
                    <nav id="main-nav" class="flex flex-wrap gap-2">
                        <button data-view="presenter" class="nav-btn px-3 py-2 rounded-md text-gray-700 hover:bg-blue-100">Prezentace</button>
                        <button data-view="speaker" class="nav-btn px-3 py-2 rounded-md text-gray-700 hover:bg-blue-100">Přihlášení</button>
                        <button data-view="voting" id="voting-nav-btn" class="nav-btn px-3 py-2 rounded-md text-gray-700 hover:bg-blue-100 hidden">Hlasování</button>
                        <button data-view="reports" id="reports-nav-btn" class="admin-only nav-btn px-3 py-2 rounded-md text-gray-700 hover:bg-blue-100 hidden">Přehledy</button>
                        <button data-view="admin" id="admin-nav-btn" class="admin-only nav-btn px-3 py-2 rounded-md text-gray-700 hover:bg-blue-100 hidden">Administrace</button>
                        <button id="logout-btn" class="ml-2 px-3 py-2 rounded-md text-red-600 hover:bg-red-100" title="Odhlásit se"><i class="fa-solid fa-right-from-bracket"></i></button>
                    </nav>
                </div>
            </header>

            <!-- Presenter View -->
            <div id="presenter-view" class="view p-4 md:p-8 bg-white rounded-lg shadow-md flex-grow">
                <div class="grid md:grid-cols-3 gap-8 h-full">
                    <div class="md:col-span-2 bg-gray-100 p-8 rounded-lg text-center flex flex-col relative justify-center">
                        <h2 id="current-speaker-title" class="text-2xl font-semibold text-gray-500 mb-4">Právě mluví</h2>
                        <p id="current-speaker-name" class="text-5xl font-bold text-blue-700 break-words">- Nikdo -</p>
                        <div class="flex flex-col md:flex-row md:flex-wrap items-center justify-center gap-x-12 gap-y-8 my-8">
                            <div id="timer-display" class="relative w-48 h-48 order-1 md:order-2"><svg class="w-full h-full" viewBox="0 0 100 100"><circle class="text-gray-300" stroke-width="8" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" /><circle id="timer-ring-circle" class="timer-ring text-blue-600" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" transform="rotate(-90 50 50)" /></svg><span id="time-left" class="absolute inset-0 flex items-center justify-center text-4xl font-mono font-bold">00:00</span></div>
                            <div id="qr-container" class="hidden w-48 h-48 bg-white p-2 rounded-lg shadow-sm order-3 md:order-1">
                                <img src="qr.png" alt="QR kód" class="w-full h-full object-contain">
                            </div>
                            <div id="timer-controls" class="flex justify-center space-x-4 order-2 md:order-3 md:w-full"><button id="start-timer-btn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-semibold disabled:bg-gray-400"><i class="fa-solid fa-play mr-2"></i>Start</button><button id="pause-timer-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2 rounded-lg font-semibold disabled:bg-gray-400"><i class="fa-solid fa-pause mr-2"></i>Pauza</button><button id="reset-timer-btn" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-semibold"><i class="fa-solid fa-sync mr-2"></i>Reset</button></div>
                        </div>
                        <button id="fullscreen-btn" class="absolute bottom-4 left-4 text-gray-400 hover:text-gray-600 z-10" title="Celá obrazovka"><i class="fa-solid fa-expand fa-lg"></i></button>
                        <button id="exit-fullscreen-btn" class="absolute bottom-4 left-4 text-gray-400 hover:text-gray-600 z-10" title="Ukončit celou obrazovku"><i class="fa-solid fa-compress fa-lg"></i></button>
                        <button id="qr-toggle-btn" class="absolute bottom-4 right-4 text-gray-400 hover:text-gray-600 z-10" title="Zobrazit QR kód"><i class="fa-solid fa-qrcode fa-lg"></i></button>
                    </div>
                    <div class="bg-gray-100 p-6 rounded-lg flex flex-col min-h-0">
                        <h2 class="text-xl font-semibold text-gray-500 mb-4 text-center flex-shrink-0">Další na řadě</h2>
                        <div class="scrollable-list-container flex-grow">
                             <ul id="speaker-queue-list" class="space-y-3 scrollable-list pr-2"></ul>
                        </div>
                        <div id="queue-summary" class="mt-4 pt-4 border-t border-gray-300 text-center text-sm text-gray-600 flex-shrink-0"></div>
                    </div>
                </div>
            </div>

            <!-- Speaker/User View -->
            <div id="speaker-view" class="view p-8 bg-white rounded-lg shadow-md flex-grow items-center justify-center">
                <div class="max-w-xl w-full">
                    <h2 class="text-2xl font-bold mb-6 text-center">Přihlásit se o slovo</h2>
                    <div id="signup-form-container">
                        <div class="mb-4"><label for="speaker-name" class="block text-gray-700 text-sm font-bold mb-2">Jméno a příjmení:</label><input type="text" id="speaker-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Jan Novák"></div>
                        <div id="party-selection-container" class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2">Politická strana:</label><div id="party-tiles" class="flex flex-wrap gap-2"></div></div>
                        <div class="mb-6"><label class="block text-gray-700 text-sm font-bold mb-2">Typ příspěvku:</label><div id="contribution-tiles" class="flex flex-wrap gap-2"></div></div>
                        <button id="signup-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed">Přihlásit se</button>
                    </div>
                     <div id="signups-disabled-message" class="hidden text-center p-4 bg-yellow-100 border border-yellow-300 rounded-lg">
                        <i class="fa-solid fa-lock text-2xl text-yellow-600 mb-2"></i>
                        <p class="font-semibold">Přihlašování je momentálně pozastaveno.</p>
                    </div>
                </div>
            </div>



            <!-- Voting View -->
            <div id="voting-view" class="view p-8 bg-white rounded-lg shadow-md flex-grow">
                <div class="max-w-4xl mx-auto w-full flex flex-col">
                    <div id="voting-hidden-message" class="hidden text-center p-6 bg-gray-50 border border-gray-200 rounded-lg">
                        <i class="fa-solid fa-eye-slash text-2xl text-gray-500 mb-2"></i>
                        <p class="font-semibold">Momentálně není k dispozici žádné viditelné hlasování.</p>
                    </div>

                    <div id="voting-panel" class="hidden flex flex-col gap-6">
                        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                            <div>
                                <h2 class="text-2xl font-bold">Hlasování</h2>
                                <p class="text-gray-600">Téma: <span id="voting-topic" class="font-semibold text-gray-800">-</span></p>
                                <p class="text-sm text-gray-500 mt-1">
                                    <span><i class="fa-solid fa-user-check mr-1"></i>Odevzdáno: <span id="voting-cast">0</span></span>
                                    <span class="ml-4"><i class="fa-solid fa-users mr-1"></i>Nastaveno: <span id="voting-total">0</span></span>
                                </p>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                <button id="vote-style-bars" class="vote-style-btn px-3 py-2 rounded-md bg-blue-100 text-blue-800 hover:bg-blue-200" data-style="bars"><i class="fa-solid fa-chart-column mr-2"></i>Sloupce</button>
                                <button id="vote-style-donut" class="vote-style-btn px-3 py-2 rounded-md bg-gray-100 text-gray-700 hover:bg-gray-200" data-style="donut"><i class="fa-solid fa-chart-pie mr-2"></i>Kruh</button>
                                <button id="vote-style-grid" class="vote-style-btn px-3 py-2 rounded-md bg-gray-100 text-gray-700 hover:bg-gray-200" data-style="grid"><i class="fa-solid fa-border-all mr-2"></i>Mřížka</button>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-3 gap-4">
                            <div class="p-4 bg-green-50 border border-green-100 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <span class="font-semibold text-green-900">ANO</span>
                                    <span class="text-sm text-green-700"><span id="voting-yes-pct">0</span>%</span>
                                </div>
                                <div class="mt-2 text-2xl font-bold text-green-800"><span id="voting-yes">0</span></div>
                            </div>
                            <div class="p-4 bg-red-50 border border-red-100 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <span class="font-semibold text-red-900">NE</span>
                                    <span class="text-sm text-red-700"><span id="voting-no-pct">0</span>%</span>
                                </div>
                                <div class="mt-2 text-2xl font-bold text-red-800"><span id="voting-no">0</span></div>
                            </div>
                            <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <span class="font-semibold text-gray-900">ZDRŽEL SE</span>
                                    <span class="text-sm text-gray-600"><span id="voting-abstain-pct">0</span>%</span>
                                </div>
                                <div class="mt-2 text-2xl font-bold text-gray-700"><span id="voting-abstain">0</span></div>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="bg-gray-50 border rounded-lg p-4">
                                <h3 class="font-bold mb-3">Hlasovat</h3>
                                <div class="grid grid-cols-3 gap-2">
                                    <button id="vote-yes-btn" class="vote-btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg">ANO</button>
                                    <button id="vote-no-btn" class="vote-btn bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg">NE</button>
                                    <button id="vote-abstain-btn" class="vote-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 rounded-lg">Zdržel se</button>
                                </div>
                                <p id="my-vote-hint" class="text-sm text-gray-600 mt-3"></p>
                            </div>

                            <div class="bg-gray-50 border rounded-lg p-4 flex flex-col">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="font-bold">Vizualizace</h3>
                                    <button id="vote-fullscreen-btn" class="hidden is-admin-only bg-gray-200 hover:bg-gray-300 px-3 py-1.5 rounded-lg text-sm">
                                        <i class="fa-solid fa-expand mr-2"></i>Celá obrazovka
                                    </button>
                                </div>
                                <div id="vote-viz" class="w-full h-[240px] md:h-[320px] overflow-hidden"></div>
                            </div>
                        </div>

                        <div id="vote-public-list" class="hidden mt-6 bg-gray-50 border rounded-lg p-4 flex flex-col mt-2">
                            <div class="flex items-center justify-between">
                                <h3 class="font-bold">Jmenné hlasování</h3>
                                <p class="text-xs text-gray-500">Zobrazeno pouze při veřejném hlasování.</p>
                            </div>
                            <div id="vote-public-columns" class="grid md:grid-cols-3 gap-4 mt-4">
                                <div class="bg-white border rounded-lg p-3 flex flex-col">
                                    <h4 class="font-semibold text-green-700 mb-2">ANO</h4>
                                    <div id="vote-public-yes" class="text-sm space-y-1"></div>
                                </div>
                                <div class="bg-white border rounded-lg p-3 flex flex-col">
                                    <h4 class="font-semibold text-red-700 mb-2">NE</h4>
                                    <div id="vote-public-no" class="text-sm space-y-1"></div>
                                </div>
                                <div class="bg-white border rounded-lg p-3 flex flex-col">
                                    <h4 class="font-semibold text-gray-700 mb-2">ZDRŽEL SE</h4>
                                    <div id="vote-public-abstain" class="text-sm space-y-1"></div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-50 border rounded-lg p-4">
                            <h3 class="font-bold mb-3">Předchozí hlasování</h3>
                            <div id="past-votes" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Admin View -->
            <div id="admin-view" class="view p-4 bg-white rounded-lg shadow-md flex-grow">
                 <div class="grid md:grid-cols-2 gap-4 h-full">
                    <div class="bg-gray-50 p-4 rounded-lg flex flex-col min-h-0">
                        <h2 class="text-2xl font-bold mb-4 flex-shrink-0">Správa pořadníku</h2>
                        <button id="next-speaker-btn" class="w-full mb-4 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg disabled:bg-gray-400 flex-shrink-0"><i class="fa-solid fa-arrow-right-to-bracket mr-2"></i> POSUNOUT DALŠÍHO</button>
                        <div class="scrollable-list-container"><ul id="admin-speaker-list" class="space-y-2 scrollable-list pr-2"></ul></div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg flex flex-col min-h-0">
                        <h2 class="text-2xl font-bold mb-4 flex-shrink-0">Nastavení</h2>
                        <div class="space-y-4 mb-4 flex-shrink-0">
                            <div class="p-3 border rounded-lg bg-white flex items-center justify-between"><label for="signups-enabled-toggle" class="flex items-center cursor-pointer w-full justify-between"><span class="font-semibold text-gray-700 mr-3">Povolit přihlašování</span><div class="relative"><input type="checkbox" id="signups-enabled-toggle" class="toggle-checkbox"><label for="signups-enabled-toggle" class="toggle-label"><div class="dot"></div></label></div></label></div>
                            <div class="p-3 border rounded-lg bg-white flex items-center justify-between"><label for="parties-enabled-toggle" class="flex items-center cursor-pointer w-full justify-between"><span class="font-semibold text-gray-700 mr-3">Povolit strany</span><div class="relative"><input type="checkbox" id="parties-enabled-toggle" class="toggle-checkbox"><label for="parties-enabled-toggle" class="toggle-label"><div class="dot"></div></label></div></label></div>
                        </div>
                        <div class="scrollable-list-container"><div class="scrollable-list pr-2 space-y-4">
                            <div class="collapsible-section">
                                <button class="collapsible-trigger w-full text-left font-bold text-lg p-2 bg-white rounded-lg shadow flex justify-between items-center"><span>Správa administrátorů</span><i class="fa-solid fa-chevron-down transform"></i></button>
                                <div class="collapsible-content space-y-3 mt-2 hidden">
                                    <div id="admins-list"></div>
                                    <div class="flex gap-4 p-4 border-t items-center"><input type="email" id="new-admin-email" placeholder="E-mail nového admina" class="flex-grow shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"><button id="add-admin-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Přidat</button></div>
                                </div>
                            </div>
                            <div class="collapsible-section">
                                <button class="collapsible-trigger w-full text-left font-bold text-lg p-2 bg-white rounded-lg shadow flex justify-between items-center"><span>Typy příspěvků</span><i class="fa-solid fa-chevron-down transform"></i></button>
                                <div class="collapsible-content space-y-3 mt-2 hidden">
                                    <div class="mb-2 text-center text-xs text-gray-500">Přetáhnutím změňte prioritu (nejvyšší je dole).</div>
                                    <div id="settings-list"></div>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 border-t items-center flex-shrink-0"><input type="text" id="new-setting-name" placeholder="Název" class="md:col-span-2 shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"><input type="number" id="new-setting-time" placeholder="Čas (s)" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"><input type="color" id="new-setting-color" value="#FFFFFF" title="Vybrat barvu" class="shadow appearance-none border rounded w-full h-10"><button id="add-setting-btn" class="md:col-span-3 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Přidat typ</button></div>
                                </div>
                            </div>
                            <div id="parties-admin-section" class="collapsible-section">
                                <button class="collapsible-trigger w-full text-left font-bold text-lg p-2 bg-white rounded-lg shadow flex justify-between items-center"><span>Politické strany</span><i class="fa-solid fa-chevron-down transform"></i></button>
                                <div class="collapsible-content space-y-3 mt-2 hidden">
                                    <div class="mb-2 text-center text-xs text-gray-500">Přetáhnutím změňte pořadí.</div>
                                    <div id="parties-list"></div>
                                    <div class="flex gap-4 p-4 border-t items-center"><input type="text" id="new-party-name" placeholder="Název strany" class="flex-grow shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"><button id="add-party-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Přidat stranu</button></div>
                                </div>
                            </div>

                            <div class="collapsible-section">
                                <button class="collapsible-trigger w-full text-left font-bold text-lg p-2 bg-white rounded-lg shadow flex justify-between items-center"><span>Správa hlasování</span><i class="fa-solid fa-chevron-down transform"></i></button>
                                <div class="collapsible-content space-y-3 mt-2 hidden">
                                    <div class="p-3 bg-white border rounded-lg">
                                        <div class="flex flex-col md:flex-row gap-2 md:items-center">
                                            <input type="text" id="new-vote-topic" placeholder="Téma hlasování" class="flex-grow shadow appearance-none border rounded w-full py-2 px-3 text-gray-700">
                                            <input type="number" id="new-vote-total" placeholder="Počet poslanců" class="w-full md:w-44 shadow appearance-none border rounded py-2 px-3 text-gray-700">
                                            <button id="add-vote-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Přidat hlasování</button>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-2">Tip: Aktivní může být vždy jen jedno hlasování.</p>
                                    </div>

                                    <div id="votes-admin-list" class="space-y-3"></div>
                                </div>
                            </div>
                        </div></div>
                    </div>
                </div>
            </div>
            <!-- Reports View -->
            <div id="reports-view" class="view p-4 bg-white rounded-lg shadow-md flex-grow">
                <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                    <h2 class="text-2xl font-bold">Přehledy přihlašování</h2>
                    <div class="flex gap-2 no-print">
                        <button id="print-reports-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                            <i class="fa-solid fa-print mr-2"></i>Tisk
                        </button>
                        <button id="reset-history-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">
                            <i class="fa-solid fa-trash-can mr-2"></i>Reset
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Google Jméno</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Uživatelská Jména</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Strany</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Typy Příspěvků</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Celkem</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider no-print">Akce</th>
                            </tr>
                        </thead>
                        <tbody id="reports-table-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"><div class="bg-white rounded-lg shadow-xl p-8 max-w-lg text-center"><p id="modal-text" class="mb-6 text-base text-left"></p><div class="flex justify-end gap-4"><button id="modal-close-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg">OK</button></div></div></div>
        <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"><div class="bg-white rounded-lg shadow-xl p-8 max-w-lg text-center"><p id="confirm-modal-text" class="mb-6 text-base text-left"></p><div class="flex justify-end gap-4"><button id="confirm-modal-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Zrušit</button><button id="confirm-modal-ok-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Potvrdit</button></div></div></div>
        <div id="edit-report-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <h2 class="text-xl font-bold mb-4">Upravit záznam</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Google Jméno</label>
                        <input type="text" id="edit-google-name" class="mt-1 block w-full border rounded-md shadow-sm p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Uživatelská Jména (jedno na řádek)</label>
                        <textarea id="edit-user-names" rows="3" class="mt-1 block w-full border rounded-md shadow-sm p-2"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Strany (jedna na řádek)</label>
                        <textarea id="edit-parties" rows="3" class="mt-1 block w-full border rounded-md shadow-sm p-2"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 font-bold">Počty příspěvků</label>
                        <div id="edit-contributions-list" class="space-y-2 mt-2">
                        </div>
                    </div>
                </div>
                <div class="flex flex-wrap justify-between mt-6 pt-4 border-t gap-4">
                    <button id="delete-report-row-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Smazat celý řádek</button>
                    <div class="flex gap-3">
                        <button id="edit-report-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Zrušit</button>
                        <button id="edit-report-save-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Uložit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

	    <!-- Vote Fullscreen Overlay (admin) -->
	    <div id="vote-fullscreen-overlay" class="hidden fixed inset-0 z-50 bg-white">
	        <div class="p-6 h-full flex flex-col">
	            <div class="flex items-start justify-between gap-4">
	                <div class="min-w-0">
	                    <div class="text-xs text-gray-500">Hlasování</div>
	                    <div id="vote-fullscreen-topic" class="text-3xl font-extrabold text-gray-900 truncate"></div>
	                    <div class="mt-2 text-sm text-gray-600">Poslanců (100%): <span id="vote-fullscreen-total" class="font-semibold"></span></div>
	                </div>
	                <button id="vote-fullscreen-exit" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg font-semibold">
	                    <i class="fa-solid fa-xmark mr-2"></i>Zavřít
	                </button>
	            </div>

	            <div class="grid md:grid-cols-3 gap-4 mt-6">
	                <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
	                    <div class="flex items-center justify-between">
	                        <span class="font-semibold text-gray-900">ANO</span>
	                        <span class="text-sm text-gray-600"><span id="vote-fullscreen-yes-pct">0</span>%</span>
	                    </div>
	                    <div class="mt-2 text-4xl font-extrabold text-gray-800"><span id="vote-fullscreen-yes">0</span></div>
	                </div>
	                <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
	                    <div class="flex items-center justify-between">
	                        <span class="font-semibold text-gray-900">NE</span>
	                        <span class="text-sm text-gray-600"><span id="vote-fullscreen-no-pct">0</span>%</span>
	                    </div>
	                    <div class="mt-2 text-4xl font-extrabold text-gray-800"><span id="vote-fullscreen-no">0</span></div>
	                </div>
	                <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
	                    <div class="flex items-center justify-between">
	                        <span class="font-semibold text-gray-900">ZDRŽEL SE</span>
	                        <span class="text-sm text-gray-600"><span id="vote-fullscreen-abstain-pct">0</span>%</span>
	                    </div>
	                    <div class="mt-2 text-4xl font-extrabold text-gray-800"><span id="vote-fullscreen-abstain">0</span></div>
	                </div>
	            </div>

	            <div class="mt-6 flex-grow min-h-0 grid lg:grid-cols-3 gap-4">
                <div id="vote-fullscreen-viz-card" class="lg:col-span-2 min-h-0 bg-gray-50 border rounded-lg p-4 overflow-hidden flex flex-col">
                    <div class="text-sm font-semibold text-gray-700 mb-3 flex-shrink-0">Vizualizace</div>
                    <div id="vote-fullscreen-viz" class="flex-grow min-h-0 overflow-hidden"></div>
                </div>

                <div id="vote-fullscreen-public" class="hidden min-h-0 bg-gray-50 border rounded-lg p-4 overflow-hidden flex flex-col">
                    <div class="flex items-center justify-between flex-shrink-0">
                        <div class="text-sm font-semibold text-gray-700">Jmenné hlasování</div>
                        <div class="text-xs text-gray-500">(veřejné)</div>
                    </div>
                    <div id="vote-fullscreen-public-columns" class="grid md:grid-cols-3 gap-3 mt-3 flex-grow min-h-0">
                        <div class="bg-white border rounded-lg p-2 flex flex-col min-h-0 overflow-hidden">
                            <div class="font-semibold text-green-700 text-sm mb-2 flex-shrink-0">ANO</div>
                            <div id="vote-fullscreen-public-yes" class="text-sm space-y-1 overflow-y-auto flex-grow min-h-0 pr-1"></div>
                        </div>
                        <div class="bg-white border rounded-lg p-2 flex flex-col min-h-0 overflow-hidden">
                            <div class="font-semibold text-red-700 text-sm mb-2 flex-shrink-0">NE</div>
                            <div id="vote-fullscreen-public-no" class="text-sm space-y-1 overflow-y-auto flex-grow min-h-0 pr-1"></div>
                        </div>
                        <div class="bg-white border rounded-lg p-2 flex flex-col min-h-0 overflow-hidden">
                            <div class="font-semibold text-gray-700 text-sm mb-2 flex-shrink-0">ZDRŽEL SE</div>
                            <div id="vote-fullscreen-public-abstain" class="text-sm space-y-1 overflow-y-auto flex-grow min-h-0 pr-1"></div>
                        </div>
                    </div>
                </div>
            </div>
	        </div>
	    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, deleteDoc, runTransaction, updateDoc, query, getDocs, where, writeBatch, orderBy, serverTimestamp, getCountFromServer, arrayUnion, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Basic Setup ---
        const firebaseConfig = {
            apiKey: "AIzaSyAyAXoqQA8SbBe2-ilDSKNoHPmTengxlEY",
            authDomain: "mluvomat.firebaseapp.com",
            projectId: "mluvomat",
            storageBucket: "mluvomat.appspot.com",
            messagingSenderId: "399583547545",
            appId: "1:399583547545:web:4e3e45b7cc952dc567e808"
        };
        if (!firebaseConfig.apiKey) document.getElementById('auth-section').innerHTML = `<h1 class="text-2xl font-bold text-red-600 mb-4">Chyba Konfigurace</h1><p class="text-gray-600">Konfigurace Firebase nebyla nalezena.</p>`;
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        const appId = 'parliament-app-default';

        const configDocRef = doc(db, "artifacts", appId, "public", "data", "config", "main");
        const queueRef = collection(db, "artifacts", appId, "public", "data", "queue");
        const votesRef = collection(db, "artifacts", appId, "public", "data", "votes");
        const historyRef = collection(db, "artifacts", appId, "public", "data", "history");
        
        // --- Global State ---
        let currentUser = null, isAdmin = false, timerInterval = null, timeRemaining = 0, totalTime = 0, isDraggingTimer = false, dbState = {};
        let selectedParty = null, selectedContribution = null, currentQueue = [];
        let votes = [], selectedVoteId = null, voteStyle = 'bars';
        let voteResponses = [], myVote = null;
        let historyData = [], currentlyEditingUserId = null;
        let unsubscribeConfig, unsubscribeQueue, unsubscribeVotes, unsubscribeVoteResponses, unsubscribeHistory; // To hold listener unsub functions

        // --- UI Element Query Selector ---
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);
        
        const ui = {
            authSection:$('#auth-section'),mainContent:$('#main-content'),userInfo:$('#user-info'),navBtns:$$('.nav-btn'),adminNavBtn:$('#admin-nav-btn'),logoutBtn:$('#logout-btn'),loginBtn:$('#login-btn'),
            views:{presenter:$('#presenter-view'),speaker:$('#speaker-view'),voting:$('#voting-view'),admin:$('#admin-view'),reports:$('#reports-view')},
            speakerNameInput:$('#speaker-name'),partyTiles:$('#party-tiles'),contributionTiles:$('#contribution-tiles'),signupBtn:$('#signup-btn'),
            adminSpeakerList:$('#admin-speaker-list'),nextSpeakerBtn:$('#next-speaker-btn'),settingsList:$('#settings-list'),
            newSettingName:$('#new-setting-name'),newSettingTime:$('#new-setting-time'),newSettingColor:$('#new-setting-color'),addSettingBtn:$('#add-setting-btn'),
            currentSpeakerTitle:$('#current-speaker-title'),currentSpeakerName:$('#current-speaker-name'),speakerQueueList:$('#speaker-queue-list'),
            timeLeftDisplay:$('#time-left'),timerRingCircle:$('#timer-ring-circle'),timerDisplay:$('#timer-display'),timerControls:$('#timer-controls'),
            startTimerBtn:$('#start-timer-btn'),pauseTimerBtn:$('#pause-timer-btn'),resetTimerBtn:$('#reset-timer-btn'),
            messageModal:$('#message-modal'),modalText:$('#modal-text'),modalCloseBtn:$('#modal-close-btn'),
            signupsEnabledToggle:$('#signups-enabled-toggle'),partiesEnabledToggle:$('#parties-enabled-toggle'),
            signupFormContainer:$('#signup-form-container'),signupsDisabledMessage:$('#signups-disabled-message'),
            queueSummary:$('#queue-summary'),
            partiesList:$('#parties-list'),newPartyNameInput:$('#new-party-name'),addPartyBtn:$('#add-party-btn'),
            partySelectionContainer:$('#party-selection-container'),partiesAdminSection:$('#parties-admin-section'),
            fullscreenBtn: $('#fullscreen-btn'), exitFullscreenBtn: $('#exit-fullscreen-btn'),
            qrToggleBtn: $('#qr-toggle-btn'), qrContainer: $('#qr-container'),
            adminsList: $('#admins-list'), newAdminEmail: $('#new-admin-email'), addAdminBtn: $('#add-admin-btn'),
            votingNavBtn: $('#voting-nav-btn'),
            reportsNavBtn: $('#reports-nav-btn'),
            votingHiddenMessage: $('#voting-hidden-message'),
            votingPanel: $('#voting-panel'),
            votingTopic: $('#voting-topic'),
            votingCast: $('#voting-cast'),
            votingTotal: $('#voting-total'),
            votingYes: $('#voting-yes'), votingNo: $('#voting-no'), votingAbstain: $('#voting-abstain'),
            votingYesPct: $('#voting-yes-pct'), votingNoPct: $('#voting-no-pct'), votingAbstainPct: $('#voting-abstain-pct'),
            voteYesBtn: $('#vote-yes-btn'), voteNoBtn: $('#vote-no-btn'), voteAbstainBtn: $('#vote-abstain-btn'),
            myVoteHint: $('#my-vote-hint'),
            voteViz: $('#vote-viz'),
	            voteFullscreenBtn: $('#vote-fullscreen-btn'),
	            voteFullscreenOverlay: $('#vote-fullscreen-overlay'),
	            voteFullscreenExitBtn: $('#vote-fullscreen-exit'),
	            voteFullscreenTopic: $('#vote-fullscreen-topic'),
	            voteFullscreenTotal: $('#vote-fullscreen-total'),
	            voteFullscreenYes: $('#vote-fullscreen-yes'),
	            voteFullscreenNo: $('#vote-fullscreen-no'),
	            voteFullscreenAbstain: $('#vote-fullscreen-abstain'),
	            voteFullscreenYesPct: $('#vote-fullscreen-yes-pct'),
	            voteFullscreenNoPct: $('#vote-fullscreen-no-pct'),
	            voteFullscreenAbstainPct: $('#vote-fullscreen-abstain-pct'),
	            voteFullscreenViz: $('#vote-fullscreen-viz'),
	            voteFullscreenVizCard: $('#vote-fullscreen-viz-card'),
	            voteFullscreenPublic: $('#vote-fullscreen-public'),
	            voteFullscreenPublicYes: $('#vote-fullscreen-public-yes'),
	            voteFullscreenPublicNo: $('#vote-fullscreen-public-no'),
	            voteFullscreenPublicAbstain: $('#vote-fullscreen-public-abstain'),
            voteStyleBtns: $$('.vote-style-btn'),
            votePublicList: $('#vote-public-list'),
            votePublicYes: $('#vote-public-yes'), votePublicNo: $('#vote-public-no'), votePublicAbstain: $('#vote-public-abstain'),
            pastVotes: $('#past-votes'),
            newVoteTopic: $('#new-vote-topic'), newVoteTotal: $('#new-vote-total'), addVoteBtn: $('#add-vote-btn'),
            votesAdminList: $('#votes-admin-list'),
            reportsTableBody: $('#reports-table-body'),
            printReportsBtn: $('#print-reports-btn'),
            resetHistoryBtn: $('#reset-history-btn'),
            editReportModal: $('#edit-report-modal'),
            editGoogleName: $('#edit-google-name'),
            editUserNames: $('#edit-user-names'),
            editParties: $('#edit-parties'),
            editContributionsList: $('#edit-contributions-list'),
            editReportSaveBtn: $('#edit-report-save-btn'),
            editReportCancelBtn: $('#edit-report-cancel-btn'),
            deleteReportRowBtn: $('#delete-report-row-btn'),
        };
        
        // --- Core Functions ---
        const showModal=(message)=>{ui.modalText.innerHTML=message;ui.messageModal.classList.remove('hidden');};
        ui.modalCloseBtn.addEventListener('click',()=>ui.messageModal.classList.add('hidden'));

        const showConfirm = (message, onConfirm) => {
            const modal = $('#confirm-modal');
            $('#confirm-modal-text').innerHTML = message;
            modal.classList.remove('hidden');
            const okBtn = $('#confirm-modal-ok-btn');
            const cancelBtn = $('#confirm-modal-cancel-btn');
            const newOk = okBtn.cloneNode(true);
            const newCancel = cancelBtn.cloneNode(true);
            okBtn.replaceWith(newOk);
            cancelBtn.replaceWith(newCancel);
            newOk.addEventListener('click', () => { onConfirm(); modal.classList.add('hidden'); });
            newCancel.addEventListener('click', () => { modal.classList.add('hidden'); });
        };
        
        const switchView=(viewName)=>{
            Object.values(ui.views).forEach(v=>v.classList.remove('active-view','flex','items-center','justify-center'));
            Object.values(ui.views).forEach(v=>v.classList.add('hidden'));
            
            if(ui.views[viewName]) {
                 ui.views[viewName].classList.remove('hidden');
                 ui.views[viewName].classList.add('active-view');
                 if(viewName === 'speaker') {
                     ui.views[viewName].classList.add('flex', 'items-center', 'justify-center');
                 }
            }
            ui.navBtns.forEach(b=>b.classList.toggle('bg-blue-200',b.dataset.view===viewName));
            if (viewName === 'speaker') {
                handleTileSelection(ui.contributionTiles, ui.contributionTiles.children[0]?.dataset.name || null, false);
                const savedParty = localStorage.getItem('parliamentPartyName');
                const partyToSelect = (savedParty !== null && [...ui.partyTiles.children].some(t => t.dataset.name === savedParty)) ? savedParty : (ui.partyTiles.children[0]?.dataset.name || null);
                handleTileSelection(ui.partyTiles, partyToSelect, true);
                updateSignupButtonState();
            }
            if (viewName === 'voting') {
                renderVoting();
            }
        };

        const isColorDark=(hex)=>{if(!hex)return false;const c=hex.substring(1),rgb=parseInt(c,16),r=(rgb>>16)&0xff,g=(rgb>>8)&0xff,b=(rgb>>0)&0xff;return(r*0.299+g*0.587+b*0.114)<186;};
        const darkenColor=(hex,percent)=>{if(!hex)return'#333333';let[r,g,b]=[parseInt(hex.slice(1,3),16),parseInt(hex.slice(3,5),16),parseInt(hex.slice(5,7),16)];r=Math.floor(r*(1-percent));g=Math.floor(g*(1-percent));b=Math.floor(b*(1-percent));return `#${((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1)}`;};
        const updateTimerDisplay=()=>{const m=Math.floor(timeRemaining/60).toString().padStart(2,'0'),s=(timeRemaining%60).toString().padStart(2,'0');ui.timeLeftDisplay.textContent=`${m}:${s}`;ui.timerRingCircle.style.strokeDashoffset=283*(1-(totalTime>0?timeRemaining/totalTime:0));};

        async function resetTimer(){if(timerInterval){clearInterval(timerInterval);timerInterval=null;}const s=dbState.state?.currentSpeaker,t=dbState.settings?.types.find(y=>y.name===s?.type);totalTime=t?t.time:0;timeRemaining=totalTime;await updateDoc(configDocRef,{"state.timer":{timeRemaining,totalTime,isRunning:false}});}
        async function advanceToNextSpeaker(){if(isDraggingTimer)return;try{await runTransaction(db,async t=>{const c=await t.get(configDocRef),s=c.data()?.settings||{types:[]};const qSnap=await getDocs(query(queueRef));let n=qSnap.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>{const pA=s.types.findIndex(x=>x.name===a.type),pB=s.types.findIndex(x=>x.name===b.type);return pA!==pB?pB-pA:(a.timestamp?.toMillis()||0)-(b.timestamp?.toMillis()||0)});const e=n.length>0?n[0]:null,o=e?s.types.find(x=>x.name===e.type):null,i=o?o.time:0;t.update(configDocRef,{"state.currentSpeaker":e?{name:e.name,type:e.type,party:e.party}:null,"state.timer":{timeRemaining:i,totalTime:i,isRunning:false}}),e&&t.delete(doc(queueRef,e.id))})}catch(e){console.error(e);showModal("Nepodařilo se přesunout řečníka.")}}
        
        function updateSignupButtonState() {
            const nameFilled = ui.speakerNameInput.value.trim() !== '';
            const partiesRequired = dbState.settings?.partiesEnabled ?? true;
            const partySelected = !partiesRequired || (selectedParty !== null);
            const contributionSelected = selectedContribution !== null;
            ui.signupBtn.disabled = !(nameFilled && partySelected && contributionSelected);
        }

        function renderQueue(queue){
            const settings=dbState.settings||{types:[]};const sorted=[...queue].sort((a,b)=>{const pA=settings.types.findIndex(s=>s.name===a.type),pB=settings.types.findIndex(s=>s.name===b.type);return pA!==pB?pB-pA:(a.timestamp?.toMillis()||0)-(b.timestamp?.toMillis()||0)});
            ui.adminSpeakerList.innerHTML='';ui.speakerQueueList.innerHTML='';let totalQueueTime=0;
            if(sorted.length===0){const e='<li class="p-3 bg-white rounded-md shadow-sm text-center text-gray-500">Seznam je prázdný.</li>';ui.adminSpeakerList.innerHTML=e;ui.speakerQueueList.innerHTML=e;}else{sorted.forEach((speaker,i)=>{const type=settings.types.find(t=>t.name===speaker.type);totalQueueTime+=type?.time||0;const bgColor=type?.color||'#FFFFFF',textColor=isColorDark(bgColor)?'text-white':'text-gray-800';const adminLi=document.createElement('li');adminLi.className=`flex justify-between items-center p-3 rounded-md shadow-sm ${textColor}`;adminLi.style.backgroundColor=bgColor;
            const partyInfo = (dbState.settings?.partiesEnabled) ? `(${(speaker.party || 'Nezávislý')})` : '';
            adminLi.innerHTML=`<div><p class="font-semibold">${speaker.name} <span class="text-sm opacity-75 font-normal">${partyInfo}</span></p><p class="text-sm opacity-75">${speaker.type}</p></div><button data-id="${speaker.id}" class="remove-speaker-btn hover:opacity-75 font-bold text-xl px-2 ${textColor}">&times;</button>`;ui.adminSpeakerList.appendChild(adminLi);const presLi=document.createElement('li');presLi.className=`p-3 rounded-md shadow-sm ${textColor}`;presLi.style.backgroundColor=bgColor;if(i===0){if(isAdmin){presLi.classList.add('cursor-pointer');}presLi.classList.add('border-4');presLi.style.borderColor=darkenColor(bgColor,0.2);presLi.id='next-speaker-tile';presLi.title=isAdmin?"Kliknutím přesunout do prezentace":"";}presLi.innerHTML=`<p class="font-semibold">${speaker.name} <span class="text-sm opacity-75 font-normal">${partyInfo}</span></p>`;ui.speakerQueueList.appendChild(presLi)})}
            ui.queueSummary.innerHTML=`<span><i class="fa-solid fa-users mr-1"></i> ${sorted.length}</span><span class="ml-4"><i class="fa-solid fa-clock mr-1"></i> ~${Math.ceil(totalQueueTime/60)} min</span>`;ui.nextSpeakerBtn.disabled=sorted.length===0;
        }

        function renderSettings(settingsData){
            const types=settingsData?.types||[],parties=settingsData?.parties||[],admins=settingsData?.admins||[];
            ui.settingsList.innerHTML='';ui.contributionTiles.innerHTML='';
            if(types.length===0){ui.settingsList.innerHTML='<p class="text-center text-gray-500">Žádné typy příspěvků.</p>';}else{types.forEach((s,i)=>{const d=document.createElement('div');d.className='setting-item p-2 bg-gray-100 rounded-md space-y-2 cursor-grab';d.dataset.name=s.name;d.draggable=true;d.innerHTML=`<div class="flex justify-between items-center"><span class="font-bold">${s.name}</span><button data-name="${s.name}" class="remove-setting-btn text-red-500 hover:text-red-700 font-bold text-xl">&times;</button></div><div class="flex justify-between items-center text-sm gap-2"><span><i class="fa-solid fa-clock w-4"></i> ${s.time}s</span><input type="color" value="${s.color||'#FFFFFF'}" class="setting-color-input" data-index="${i}" title="Změnit barvu"><span><i class="fa-solid fa-users-slash w-4"></i> Max:</span><input type="number" value="${s.maxSignups||''}" class="setting-max-input w-16 text-center border rounded" placeholder="∞" data-index="${i}"></div>`;ui.settingsList.appendChild(d);const t=document.createElement('button');const o=isColorDark(s.color)?'text-white':'text-gray-800';t.className=`tile p-2 rounded-lg hover:opacity-80 ${o}`;t.style.backgroundColor=s.color||'#E5E7EB';t.dataset.name=s.name;t.textContent=s.name;ui.contributionTiles.appendChild(t)})}
            
            ui.adminsList.innerHTML = '';
            admins.forEach((email, i) => { const div = document.createElement('div'); div.className = 'flex justify-between items-center p-2 bg-gray-100 rounded-md'; const removeBtn = (admins.length > 1) ? `<button data-email="${email}" class="remove-admin-btn text-red-500 hover:text-red-700 font-bold text-xl">&times;</button>` : `<i class="fa-solid fa-crown text-yellow-500" title="Super admin"></i>`; div.innerHTML = `<span>${email}</span>${removeBtn}`; ui.adminsList.appendChild(div); });
            
            const partiesEnabled=settingsData?.partiesEnabled??true;
            ui.partiesAdminSection.style.display=partiesEnabled?'block':'none';
            ui.partySelectionContainer.style.display=partiesEnabled?'block':'none';
            ui.partiesEnabledToggle.checked=partiesEnabled;
            
            ui.partiesList.innerHTML='';ui.partyTiles.innerHTML='';
            const nezavislyTile=document.createElement('button');nezavislyTile.className='tile p-2 rounded-lg bg-gray-200 hover:bg-gray-300';nezavislyTile.dataset.name='';nezavislyTile.textContent='Nezávislý';ui.partyTiles.appendChild(nezavislyTile);
            if(parties.length===0){ui.partiesList.innerHTML='<p class="text-center text-gray-500">Žádné politické strany.</p>';}else{parties.forEach(p=>{const d=document.createElement('div');d.className='flex justify-between items-center p-2 bg-gray-100 rounded-md';d.innerHTML=`<span>${p.name}</span><button data-name="${p.name}" class="remove-party-btn text-red-500 hover:text-red-700 font-bold text-xl">&times;</button>`;ui.partiesList.appendChild(d);const t=document.createElement('button');t.className='tile p-2 rounded-lg bg-gray-200 hover:bg-gray-300';t.dataset.name=p.name;t.textContent=p.name;ui.partyTiles.appendChild(t)})}
            
            handleTileSelection(ui.contributionTiles, ui.contributionTiles.children[0]?.dataset.name || null, false);
            const savedParty = localStorage.getItem('parliamentPartyName');
            const partyToSelect = (savedParty !== null && [...ui.partyTiles.children].some(t => t.dataset.name === savedParty)) ? savedParty : (ui.partyTiles.children[0]?.dataset.name || null);
            handleTileSelection(ui.partyTiles, partyToSelect, true);
        }
        


        // --- Voting (Hlasování) ---
        function voteDocRef(voteId){
            return doc(db, "artifacts", appId, "public", "data", "votes", voteId);
        }
        function voteResponsesRef(voteId){
            return collection(db, "artifacts", appId, "public", "data", "votes", voteId, "responses");
        }

        function getVisibleVotes(){
            if (isAdmin) return votes;
            return votes.filter(v => v.visible === true);
        }

        function getActiveVote(){
            return votes.find(v => v.active === true) || null;
        }

        function updateVotingNavVisibility(){
            const hasAnyVisible = getVisibleVotes().length > 0;
            // admin uvidí vždy (kvůli správě a náhledu)
            if (!ui.votingNavBtn) return;
            ui.votingNavBtn.classList.toggle('hidden', !(isAdmin || hasAnyVisible));
        }

        function setVoteStyle(style){
            voteStyle = style;
            ui.voteStyleBtns.forEach(btn => {
                const active = btn.dataset.style === style;
                btn.classList.toggle('bg-blue-100', active);
                btn.classList.toggle('text-blue-800', active);
                btn.classList.toggle('bg-gray-100', !active);
                btn.classList.toggle('text-gray-700', !active);
            });
            renderVoteVisualization();
        }

        function formatPct(n){
            if (!isFinite(n)) return '0';
            return String(Math.round(n));
        }

        function computeTallies(totalMembers, responses){
            const yes = responses.filter(r => r.choice === 'yes').length;
            const no = responses.filter(r => r.choice === 'no').length;
            const abstain = responses.filter(r => r.choice === 'abstain').length;
            const total = Math.max(0, Number(totalMembers||0));
            const pct = (c) => total > 0 ? (c/total)*100 : 0;
            return { yes, no, abstain, cast: responses.length, total, yesPct: pct(yes), noPct: pct(no), abstainPct: pct(abstain) };
        }
        function renderBarsViz(t, opts = {}){
            const rows = [
                { label: 'ANO', count: t.yes, pct: t.yesPct, cls: 'bg-green-600' },
                { label: 'NE', count: t.no, pct: t.noPct, cls: 'bg-red-600' },
                { label: 'Zdržel se', count: t.abstain, pct: t.abstainPct, cls: 'bg-gray-600' },
            ];

            const barPx = Number(opts.barPx);
            const barHClass = opts.barH || 'h-3';
            const usePx = Number.isFinite(barPx) && barPx > 0;

            const wrapClass = opts.fullscreen ? 'w-full max-w-4xl' : 'w-full';
            return `
                <div class="${wrapClass} space-y-4">
                    ${rows.map(r => {
                        const hClass = usePx ? '' : barHClass;
                        const hStyle = usePx ? `height:${Math.round(barPx)}px;` : '';
                        return `
                            <div>
                                <div class="flex justify-between text-sm md:text-base mb-2">
                                    <span class="font-semibold">${r.label}</span>
                                    <span>${r.count} (${formatPct(r.pct)}%)</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full overflow-hidden ${hClass}" style="${hStyle}">
                                    <div class="${r.cls} ${hClass}" style="width:${Math.min(100, Math.max(0, r.pct)).toFixed(2)}%;${hStyle}"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

function renderDonutViz(t, opts = {}){
            const size = opts.size || 180;
            const r = opts.r || Math.round(size * 0.39);
            const c = 2 * Math.PI * r;
            const seg = [
                { key:'yes', val: t.yesPct, cls: 'stroke-green-600' },
                { key:'no', val: t.noPct, cls: 'stroke-red-600' },
                { key:'abstain', val: t.abstainPct, cls: 'stroke-gray-600' },
            ];
            let offset = 0;
            const circles = seg.map(s => {
                const dash = (Math.min(100, Math.max(0, s.val))/100)*c;
                const out = `<circle r="${r}" cx="${size/2}" cy="${size/2}" fill="transparent" stroke-width="${opts.stroke || 16}" class="${s.cls}" stroke-dasharray="${dash} ${c-dash}" stroke-dashoffset="${-offset}" stroke-linecap="round" />`;
                offset += dash;
                return out;
            }).join('');
            return `
                <div class="flex flex-col items-center justify-center">
                    <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
                        <circle r="${r}" cx="${size/2}" cy="${size/2}" fill="transparent" stroke-width="${opts.stroke || 16}" class="stroke-gray-200" />
                        <g transform="rotate(-90 ${size/2} ${size/2})">${circles}</g>
                        <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" class="fill-gray-800" font-size="18" font-weight="700">${t.cast}/${t.total}</text>
                        <text x="50%" y="58%" dominant-baseline="middle" text-anchor="middle" class="fill-gray-500" font-size="12">hlasů</text>
                    </svg>
                    <div class="text-xs text-gray-500">(z ${t.total} nastavených)</div>
                </div>
            `;
        }

        function renderGridViz(t, opts = {}){
            const totalCells = 100;
            const yesCells = t.total>0 ? Math.round((t.yes/t.total)*totalCells) : 0;
            const noCells = t.total>0 ? Math.round((t.no/t.total)*totalCells) : 0;
            const abstainCells = t.total>0 ? Math.round((t.abstain/t.total)*totalCells) : 0;
            const used = Math.min(totalCells, yesCells + noCells + abstainCells);
            const rest = Math.max(0, totalCells - used);
            const cells = [
                ...Array(yesCells).fill('bg-green-600'),
                ...Array(noCells).fill('bg-red-600'),
                ...Array(abstainCells).fill('bg-gray-600'),
                ...Array(rest).fill('bg-gray-200'),
            ].slice(0, totalCells);

            // Backwards compatible: either Tailwind class (cellClass) or pixel size (cellPx)
            const cellClass = opts.cellClass || 'w-3 h-3';
            const cellPx = Number.isFinite(opts.cellPx) ? Math.max(4, opts.cellPx) : null;
            const cellStyle = cellPx ? `style="width:${cellPx}px;height:${cellPx}px"` : '';

            return `
                <div class="w-full ${opts.fullscreen ? 'h-full flex items-center justify-center' : 'flex flex-col items-center'}">
                    <div class="grid grid-cols-10 gap-1">
                        ${cells.map(cls => `<div class="${cellPx ? '' : cellClass} rounded-sm ${cls}" ${cellStyle}></div>`).join('')}
                    </div>
                </div>
            `;
        }

        function renderVoteVisualizationInto(targetEl, opts = {}){
            const vote = votes.find(v => v.id === selectedVoteId) || getActiveVote();
            if (!vote) { if (targetEl) targetEl.innerHTML = ''; return; }
            if (vote.resultsVisible === false) {
                if (targetEl) targetEl.innerHTML = '<div class="h-full flex items-center justify-center text-gray-400 text-sm italic p-4 text-center">Výsledky budou zobrazeny po ukončení hlasování.</div>';
                return;
            }

            // Auto-size for bars/grid based on available space (especially fullscreen + mobile)
            const w = (targetEl?.clientWidth || 0);
            const h = (targetEl?.clientHeight || 0);
            const fullscreen = !!opts.fullscreen;

            const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
            const autoBarPx = (h > 0) ? clamp(Math.floor(h / (fullscreen ? 10 : 14)), fullscreen ? 14 : 10, fullscreen ? 44 : 22) : null;
            const autoCellPx = (w > 0 && h > 0) ? clamp(Math.floor(Math.min(w, h) / (fullscreen ? 14 : 18)), fullscreen ? 8 : 6, fullscreen ? 42 : 18) : null;

            const t = computeTallies(vote.totalMembers, voteResponses);

            const wrap = (html) => {
                if (fullscreen) {
                    return `<div class="w-full h-full flex items-center justify-center">${html}</div>`;
                }
                return html;
            };

            if (voteStyle === 'donut') {
                targetEl.innerHTML = wrap(renderDonutViz(t, opts));
            } else if (voteStyle === 'grid') {
                const o = { ...opts };
                if (!Number.isFinite(o.cellPx)) o.cellPx = autoCellPx;
                targetEl.innerHTML = wrap(renderGridViz(t, o));
            } else {
                const o = { ...opts };
                if (!Number.isFinite(o.barPx)) o.barPx = autoBarPx;
                targetEl.innerHTML = wrap(renderBarsViz(t, o));
            }
        }

        function renderVoteVisualization(){
            if (!ui.voteViz) return;
            renderVoteVisualizationInto(ui.voteViz, {});
        }

        function renderPublicVotingList(vote){
            if (!vote || (vote.resultsVisible === false)) { ui.votePublicList.classList.add('hidden'); return; }
            const isSecret = vote.secret === true;
            const showNames = !isSecret;
            ui.votePublicList.classList.toggle('hidden', !showNames);
            if (!showNames) return;

            const yes = voteResponses.filter(r => r.choice === 'yes');
            const no = voteResponses.filter(r => r.choice === 'no');
            const abstain = voteResponses.filter(r => r.choice === 'abstain');

            const renderPerson = (r) => {
                const party = (r.party || '').trim();
                const partyTxt = party ? ` <span class="text-xs text-gray-500">(${party})</span>` : '';
                return `<div class="p-2 bg-gray-50 rounded">${(r.name||'Neznámý')} ${partyTxt}</div>`;
            };
            ui.votePublicYes.innerHTML = yes.map(renderPerson).join('') || '<div class="text-sm text-gray-400">-</div>';
            ui.votePublicNo.innerHTML = no.map(renderPerson).join('') || '<div class="text-sm text-gray-400">-</div>';
            ui.votePublicAbstain.innerHTML = abstain.map(renderPerson).join('') || '<div class="text-sm text-gray-400">-</div>';
        }

        function renderPastVotesButtons(){
            // Show ALL visible votes here, including the active one.
            const visible = getVisibleVotes().slice().sort((a,b)=> (b.createdAt?.toMillis?.()||0)-(a.createdAt?.toMillis?.()||0));
            const active = getActiveVote();
            const list = visible;
            ui.pastVotes.innerHTML = '';
            if (list.length === 0) {
                ui.pastVotes.innerHTML = '<span class="text-sm text-gray-500">Žádná předchozí hlasování.</span>';
                return;
            }
            list.forEach(v => {
                const btn = document.createElement('button');
                const isActive = active && v.id === active.id;
                const isSelected = selectedVoteId && v.id === selectedVoteId;
                btn.className = 'px-3 py-2 rounded-md text-sm border ' +
                    (isSelected ? 'bg-blue-200 border-blue-400' : 'bg-gray-200 hover:bg-gray-300 border-transparent');
                btn.textContent = (v.topic || '(bez tématu)') + (isActive ? '  • AKTIVNÍ' : '');
                if (isActive) btn.classList.add('ring-2','ring-green-400');
                btn.dataset.voteId = v.id;
                ui.pastVotes.appendChild(btn);
            });
        }

        function renderVoting(){
            updateVotingNavVisibility();
            const visibleVotes = getVisibleVotes();
            if (!isAdmin && visibleVotes.length === 0) {
                ui.votingHiddenMessage.classList.remove('hidden');
                ui.votingPanel.classList.add('hidden');
                return;
            }
            ui.votingHiddenMessage.classList.add('hidden');
            ui.votingPanel.classList.remove('hidden');

            const active = getActiveVote();
            if (!selectedVoteId) selectedVoteId = active?.id || visibleVotes[0]?.id || null;
            if (!isAdmin && selectedVoteId && !visibleVotes.some(v => v.id === selectedVoteId)) {
                selectedVoteId = active?.id || visibleVotes[0]?.id || null;
            }

            const vote = votes.find(v => v.id === selectedVoteId) || active;
            if (!vote) {
                ui.votingHiddenMessage.classList.remove('hidden');
                ui.votingPanel.classList.add('hidden');
                return;
            }

            ui.votingTopic.textContent = vote.topic || '-';
            ui.votingTotal.textContent = String(vote.totalMembers ?? 0);

            let t = computeTallies(vote.totalMembers, voteResponses);
            if (vote.resultsVisible === false) {
                t = { yes: 0, no: 0, abstain: 0, cast: t.cast, total: t.total, yesPct: 0, noPct: 0, abstainPct: 0 };
            }
            ui.votingCast.textContent = String(t.cast);
            ui.votingYes.textContent = String(t.yes);
            ui.votingNo.textContent = String(t.no);
            ui.votingAbstain.textContent = String(t.abstain);
            ui.votingYesPct.textContent = formatPct(t.yesPct);
            ui.votingNoPct.textContent = formatPct(t.noPct);
            ui.votingAbstainPct.textContent = formatPct(t.abstainPct);

            // moje volba
            myVote = voteResponses.find(r => r.id === currentUser?.uid) || null;
            const activeVisible = vote.active === true && (vote.visible === true || isAdmin);
            const canVote = activeVisible;

            const setVoteBtnState = (btn, choice) => {
                const selected = myVote?.choice === choice;
                btn.classList.toggle('ring-4', selected);
                btn.classList.toggle('ring-blue-300', selected);
                btn.disabled = !canVote;
                btn.classList.toggle('opacity-50', !canVote);
                btn.classList.toggle('cursor-not-allowed', !canVote);
            };
            setVoteBtnState(ui.voteYesBtn, 'yes');
            setVoteBtnState(ui.voteNoBtn, 'no');
            setVoteBtnState(ui.voteAbstainBtn, 'abstain');

            if (!canVote) {
                ui.myVoteHint.textContent = 'Toto hlasování není aktivní. Můžete si prohlédnout výsledky.';
            } else if (!myVote) {
                ui.myVoteHint.innerHTML = '<span class="font-semibold text-blue-700">Ještě jste nehlasoval/a.</span> Zvolte ANO / NE / Zdržel se.';
            } else {
                const map = { yes: 'ANO', no: 'NE', abstain: 'Zdržel se' };
                ui.myVoteHint.innerHTML = `Už jste hlasoval/a: <span class="font-semibold">${map[myVote.choice]}</span>. Kliknutím můžete změnit volbu.`;
            }

            renderVoteVisualization();
            renderPublicVotingList(vote);
            renderPastVotesButtons();

	            // keep fullscreen overlay in sync if it's open
	            if (ui.voteFullscreenOverlay && !ui.voteFullscreenOverlay.classList.contains('hidden')) {
	                renderVoteFullscreen();
	            }
        }

	        function renderVoteFullscreen(){
	            if (!isAdmin || !ui.voteFullscreenOverlay) return;
	            const vote = votes.find(v => v.id === selectedVoteId) || getActiveVote();
	            if (!vote) return;
	            ui.voteFullscreenTopic.textContent = vote.topic || '-';
	            ui.voteFullscreenTotal.textContent = String(vote.totalMembers ?? 0);
	            // reuse already rendered counters/pcts (same source of truth)
	            ui.voteFullscreenYes.textContent = ui.votingYes.textContent;
	            ui.voteFullscreenNo.textContent = ui.votingNo.textContent;
	            ui.voteFullscreenAbstain.textContent = ui.votingAbstain.textContent;
	            ui.voteFullscreenYesPct.textContent = ui.votingYesPct.textContent;
	            ui.voteFullscreenNoPct.textContent = ui.votingNoPct.textContent;
	            ui.voteFullscreenAbstainPct.textContent = ui.votingAbstainPct.textContent;

	            // Render visualization with larger sizing to fill space
	            if (ui.voteFullscreenViz) {
	                const w = ui.voteFullscreenViz.clientWidth || 800;
	                const h = ui.voteFullscreenViz.clientHeight || 500;
	                const donutSize = Math.max(240, Math.min(560, Math.min(w, h) - 40));
	                const cellClass = (Math.min(w, h) >= 520) ? 'w-5 h-5' : 'w-4 h-4';
	                renderVoteVisualizationInto(ui.voteFullscreenViz, {
                        fullscreen: true,
                        size: donutSize,
                        stroke: (donutSize >= 420 ? 22 : 18),
                        // bars/grid will auto-size from container; donut uses size/stroke
                    });
	            }

	            // Public (named) list in fullscreen for public votes
	            const showNames = (vote.secret !== true);
	            if (ui.voteFullscreenVizCard) {
	                ui.voteFullscreenVizCard.classList.toggle('lg:col-span-3', !showNames);
	                ui.voteFullscreenVizCard.classList.toggle('lg:col-span-2', showNames);
	            }
	            if (ui.voteFullscreenPublic) {
	                ui.voteFullscreenPublic.classList.toggle('hidden', !showNames);
	                if (showNames) {
	                    const yes = voteResponses.filter(r => r.choice === 'yes');
	                    const no = voteResponses.filter(r => r.choice === 'no');
	                    const abstain = voteResponses.filter(r => r.choice === 'abstain');
	                    const renderPerson = (r) => {
	                        const party = (r.party || '').trim();
	                        const partyTxt = party ? ` <span class="text-xs text-gray-500">(${party})</span>` : '';
	                        return `<div class="p-2 bg-gray-50 rounded">${(r.name||'Neznámý')} ${partyTxt}</div>`;
	                    };
	                    if (ui.voteFullscreenPublicYes) ui.voteFullscreenPublicYes.innerHTML = yes.map(renderPerson).join('') || '<div class="text-sm text-gray-400">-</div>';
	                    if (ui.voteFullscreenPublicNo) ui.voteFullscreenPublicNo.innerHTML = no.map(renderPerson).join('') || '<div class="text-sm text-gray-400">-</div>';
	                    if (ui.voteFullscreenPublicAbstain) ui.voteFullscreenPublicAbstain.innerHTML = abstain.map(renderPerson).join('') || '<div class="text-sm text-gray-400">-</div>';
	                }
	            }
	        }

	        async function openVoteFullscreen(){
	            if (!isAdmin || !ui.voteFullscreenOverlay) return;
	            renderVoteFullscreen();
	            ui.voteFullscreenOverlay.classList.remove('hidden');
	            requestAnimationFrame(() => { try { renderVoteFullscreen(); } catch(e){} });
	            try {
	                // try native fullscreen (optional)
	                if (ui.voteFullscreenOverlay.requestFullscreen) await ui.voteFullscreenOverlay.requestFullscreen();
	            } catch (e) {
	                // ignore (browser/permissions)
	            }
	        }

	        async function closeVoteFullscreen(){
	            if (!ui.voteFullscreenOverlay) return;
	            ui.voteFullscreenOverlay.classList.add('hidden');
	            try {
	                if (document.fullscreenElement) await document.exitFullscreen();
	            } catch (e) {
	                // ignore
	            }
	        }

        async function selectVote(voteId){
            selectedVoteId = voteId;
            await startVoteResponsesListener(voteId);
            renderVoting();
        }

        async function castVote(choice){
            const vote = votes.find(v => v.id === selectedVoteId) || getActiveVote();
            if (!vote || !(vote.active === true && (vote.visible === true || isAdmin))) {
                return showModal('Toto hlasování není aktivní nebo není viditelné.');
            }
            if (!currentUser) return;
            const name = (localStorage.getItem('parliamentSpeakerName') || currentUser.displayName || currentUser.email || '').trim();
            const party = (localStorage.getItem('parliamentPartyName') || selectedParty || '').trim();
            const ref = doc(voteResponsesRef(vote.id), currentUser.uid);
            await setDoc(ref, { choice, name, party, updatedAt: serverTimestamp() }, { merge: true });
        }

        async function startVoteResponsesListener(voteId){
            if (unsubscribeVoteResponses) unsubscribeVoteResponses();
            voteResponses = [];
            if (!voteId) return;
            unsubscribeVoteResponses = onSnapshot(query(voteResponsesRef(voteId), orderBy('updatedAt','desc')), (snap) => {
                voteResponses = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if (isAdmin) {
                    voteCounts[voteId] = snap.size;
                }
                renderVoting();
                if (isAdmin) renderVotesAdmin();
            }, (err) => {
                console.error('Vote responses listener error:', err);
                showModal('Chyba načítání hlasů: ' + (err?.message || err));
            });
        }

        let voteCounts = {}; // { voteId: count }
        let openDetailVoteId = null;

        function renderVotesAdmin(){
            if (!isAdmin) return;
            ui.votesAdminList.innerHTML = '';
            const sorted = votes.slice().sort((a,b)=> (b.createdAt?.toMillis?.()||0)-(a.createdAt?.toMillis?.()||0));
            if (sorted.length === 0) {
                ui.votesAdminList.innerHTML = '<p class="text-center text-gray-500">Žádná hlasování.</p>';
                return;
            }
            sorted.forEach(v => {
                const card = document.createElement('div');
                card.className = 'p-3 bg-white border rounded-lg space-y-3';
                card.dataset.voteId = v.id;

                const active = v.active === true;
                const visible = v.visible === true;
                const secret = v.secret === true;
                const resultsVisible = v.resultsVisible === true;

                card.innerHTML = `
                    <div class="flex items-start justify-between gap-3">
                        <div class="min-w-0">
                            <div class="flex items-center gap-2">
                                <span class="font-bold">${v.topic || '(bez tématu)'}</span>
                                ${active ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">AKTIVNÍ</span>' : ''}
                                ${visible ? '<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">VIDITELNÉ</span>' : '<span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">SKRYTÉ</span>'}
                                ${secret ? '<span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">TAJNÉ</span>' : '<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">VEŘEJNÉ</span>'}
                                ${resultsVisible ? '<span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">VÝSLEDKY</span>' : '<span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">BEZ VÝSLEDKŮ</span>'}
                            </div>
                            <div class="text-sm text-gray-600 mt-1">
                                Nastaveno poslanců: <span class="font-semibold">${v.totalMembers ?? 0}</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-1">
                            <button class="reset-vote-btn text-yellow-600 hover:text-yellow-800 px-2" title="Resetovat hlasy"><i class="fa-solid fa-rotate-left"></i></button>
                            <button class="delete-vote-btn text-red-600 hover:text-red-800 px-2" title="Smazat"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-3">
                        <div class="p-2 border rounded-lg">
                            <div class="flex items-center justify-between">
                                <span class="font-semibold text-gray-700">Aktivní</span>
                                <div class="relative">
                                    <input type="checkbox" class="toggle-checkbox vote-active-toggle" id="act-${v.id}" ${active ? 'checked' : ''}>
                                    <label for="act-${v.id}" class="toggle-label"><div class="dot"></div></label>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1 leading-tight">Aktivní hlasování.</p>
                        </div>
                        <div class="p-2 border rounded-lg">
                            <div class="flex items-center justify-between">
                                <span class="font-semibold text-gray-700">Zobrazit</span>
                                <div class="relative">
                                    <input type="checkbox" class="toggle-checkbox vote-visible-toggle" id="vis-${v.id}" ${visible ? 'checked' : ''}>
                                    <label for="vis-${v.id}" class="toggle-label"><div class="dot"></div></label>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1 leading-tight">Viditelné pro poslance.</p>
                        </div>
                        <div class="p-2 border rounded-lg">
                            <div class="flex items-center justify-between">
                                <span class="font-semibold text-gray-700">Tajné</span>
                                <div class="relative">
                                    <input type="checkbox" class="toggle-checkbox vote-secret-toggle" id="sec-${v.id}" ${secret ? 'checked' : ''}>
                                    <label for="sec-${v.id}" class="toggle-label"><div class="dot"></div></label>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1 leading-tight">Bez jmen u poslanců.</p>
                        </div>
                        <div class="p-2 border rounded-lg">
                            <div class="flex items-center justify-between">
                                <span class="font-semibold text-gray-700">Výsledky</span>
                                <div class="relative">
                                    <input type="checkbox" class="toggle-checkbox vote-results-toggle" id="res-${v.id}" ${resultsVisible ? 'checked' : ''}>
                                    <label for="res-${v.id}" class="toggle-label"><div class="dot"></div></label>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1 leading-tight">Zobrazit výsledky.</p>
                        </div>
                    </div>

                    <div class="p-2 border rounded-lg">
                        <label class="text-sm font-semibold text-gray-700">Počet přihlášených poslanců (100%)</label>
                        <div class="flex gap-2 mt-2 items-center">
                            <input type="number" class="vote-total-input flex-grow shadow appearance-none border rounded py-2 px-3 text-gray-700" value="${v.totalMembers ?? 0}">
                            <div class="flex flex-col items-center px-2 min-w-[80px]">
                                <span class="text-[10px] text-gray-500 uppercase font-bold">Hlasovalo</span>
                                <span class="text-lg font-bold ${(voteCounts[v.id] || 0) !== (v.totalMembers || 0) ? 'text-red-600' : 'text-green-600'}">
                                    ${voteCounts[v.id] || 0}
                                </span>
                            </div>
                            <button class="open-vote-details-btn bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded-lg text-sm"><i class="fa-solid fa-list mr-2"></i>Detaily</button>
                        </div>
                    </div>

                    <div class="vote-details ${openDetailVoteId === v.id ? '' : 'hidden'} p-3 bg-gray-50 border rounded-lg">
                        <div class="flex items-center justify-between">
                            <span class="font-bold">Kdo hlasoval</span>
                            <button class="close-vote-details-btn text-gray-600 hover:text-gray-800"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <div class="vote-details-list mt-3 space-y-2"></div>
                    </div>
                `;
                ui.votesAdminList.appendChild(card);
            });

            if (openDetailVoteId) {
                const openCard = ui.votesAdminList.querySelector(`[data-vote-id="${openDetailVoteId}"]`);
                if (openCard) renderVoteDetails(openCard);
            }
        }

        async function deleteVote(voteId){
            try{
                // Smazat i podkolekci responses (pro běžné školní objemy ok)
                const respSnap = await getDocs(query(voteResponsesRef(voteId)));
                const b = writeBatch(db);
                respSnap.docs.forEach(d => b.delete(d.ref));
                b.delete(voteDocRef(voteId));
                await b.commit();
            }catch(e){
                console.error(e);
                showModal('Smazání hlasování selhalo.');
            }
        }

        async function setVoteActive(voteId, shouldBeActive){
            try{
                const snap = await getDocs(query(votesRef));
                const b = writeBatch(db);
                snap.docs.forEach(d => {
                    const isTarget = d.id === voteId;
                    b.update(d.ref, { active: shouldBeActive ? isTarget : false });
                });
                await b.commit();
            }catch(e){
                console.error(e);
                showModal('Nepodařilo se změnit aktivní hlasování.');
            }
        }

        async function updateVoteField(voteId, data){
            try{
                await updateDoc(voteDocRef(voteId), data);
            }catch(e){
                console.error(e);
                showModal('Nepodařilo se uložit změnu hlasování.');
            }
        }

        async function renderVoteDetails(card){
            const voteId = card.dataset.voteId;
            const details = card.querySelector('.vote-details');
            const list = card.querySelector('.vote-details-list');
            details.classList.remove('hidden');
            list.innerHTML = '<div class="text-sm text-gray-500">Načítám...</div>';
            try{
                const snap = await getDocs(query(voteResponsesRef(voteId), orderBy('updatedAt','desc')));
                const rows = snap.docs.map(d => ({ id:d.id, ...d.data() }));
                if (rows.length === 0){
                    list.innerHTML = '<div class="text-sm text-gray-400">Zatím nikdo nehlasoval.</div>';
                    return;
                }
                const map = { yes:'ANO', no:'NE', abstain:'Zdržel se' };
                list.innerHTML = rows.map(r => {
                    const party = (r.party||'').trim();
                    const partyTxt = party ? ` <span class="text-xs text-gray-500">(${party})</span>` : '';
                    return `
                        <div class="flex items-center justify-between bg-white border rounded p-2">
                            <div class="min-w-0">
                                <div class="font-semibold text-sm truncate">${(r.name||'Neznámý')} ${partyTxt}</div>
                                <div class="text-xs text-gray-500">${map[r.choice] || '-'}</div>
                            </div>
                            <button class="delete-vote-response-btn text-red-600 hover:text-red-800 px-2" title="Vymazat hlas"><i class="fa-solid fa-eraser"></i></button>
                        </div>
                    `;
                }).join('');

                // navážeme delete tlačítka
                list.querySelectorAll('.delete-vote-response-btn').forEach((btn, idx) => {
                    btn.addEventListener('click', async () => {
                        const r = rows[idx];
                        await deleteDoc(doc(voteResponsesRef(voteId), r.id));
                    });
                });
            }catch(e){
                console.error(e);
                list.innerHTML = '<div class="text-sm text-red-600">Chyba načítání.</div>';
            }
        }

        // --- OPRAVENÁ FUNKCE ---
        async function ensureMainConfigExists() {
            const userEmail = auth.currentUser?.email;
            if (!userEmail) return;

            const docSnap = await getDoc(configDocRef);
            if (!docSnap.exists()) {
                console.log("Creating initial config document...");
                try {
                    await setDoc(configDocRef, {
                        settings: {
                            signupsEnabled: true,
                            partiesEnabled: true,
                            admins: [userEmail], // První přihlášený uživatel je admin
                            types: [
                                { name: "Standardní příspěvek", time: 180, color: "#BFDBFE", maxSignups: null },
                                { name: "Reakce", time: 60, color: "#FED7D7", maxSignups: null },
                                { name: "Faktická poznámka", time: 30, color: "#BEE3F8", maxSignups: null }
                            ],
                            parties: [
                                { name: "Vládní strana" }, { name: "Opoziční strana" }
                            ]
                        },
                        state: {
                            currentSpeaker: null,
                            timer: { timeRemaining: 0, totalTime: 0, isRunning: false }
                        }
                    });
                } catch(e) {
                    console.error("Error creating initial config:", e);
                    showModal("Nepodařilo se vytvořit úvodní nastavení. Zkuste to prosím znovu.");
                }
            }
        }
        
        function setUiForAdmin(isAdminStatus) {
            ui.adminNavBtn.style.display = isAdminStatus ? 'inline-block' : 'none';
            ui.reportsNavBtn.style.display = isAdminStatus ? 'inline-block' : 'none';
            ui.timerControls.style.display = isAdminStatus ? 'flex' : 'none';
            if (ui.voteFullscreenBtn) ui.voteFullscreenBtn.classList.toggle('hidden', !isAdminStatus);
            if (!isAdminStatus) { ui.timerDisplay.style.cursor = 'default'; isDraggingTimer = false; } 
            else { ui.timerDisplay.style.cursor = 'grab'; }
            document.body.classList.toggle('is-admin', isAdminStatus);
        }

        function renderReports() {
            if (!isAdmin) return;
            console.log('Rendering reports, records:', historyData.length);
            ui.reportsTableBody.innerHTML = '';
            if (historyData.length === 0) {
                ui.reportsTableBody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500 italic">Žádná data v historii.</td></tr>';
                return;
            }
            historyData.sort((a,b) => (a.googleName || '').localeCompare(b.googleName || '')).forEach(user => {
                const tr = document.createElement('tr');
                const contributions = Object.entries(user.contributions || {})
                    .map(([type, count]) => `${type} (${count}x)`)
                    .join(', ');

                tr.innerHTML = `
                    <td class="px-4 py-4 text-sm text-gray-900">${user.googleName || '-'}</td>
                    <td class="px-4 py-4 text-sm text-gray-500">${(user.userNames || []).join(', ')}</td>
                    <td class="px-4 py-4 text-sm text-gray-500">${(user.parties || []).join(', ')}</td>
                    <td class="px-4 py-4 text-sm text-gray-500">${contributions}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.totalCount || 0}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium no-print">
                        <button class="edit-report-btn text-blue-600 hover:text-blue-900" data-id="${user.id}"><i class="fa-solid fa-pen-to-square"></i></button>
                    </td>
                `;
                ui.reportsTableBody.appendChild(tr);
            });

            ui.reportsTableBody.querySelectorAll('.edit-report-btn').forEach(btn => {
                btn.addEventListener('click', () => openEditReportModal(btn.dataset.id));
            });
        }

        function openEditReportModal(userId) {
            const user = historyData.find(u => u.id === userId);
            if (!user) return;
            currentlyEditingUserId = userId;
            ui.editGoogleName.value = user.googleName || '';
            ui.editUserNames.value = (user.userNames || []).join('\n');
            ui.editParties.value = (user.parties || []).join('\n');

            ui.editContributionsList.innerHTML = '';
            const allTypes = new Set([...(dbState.settings?.types || []).map(t => t.name), ...Object.keys(user.contributions || {})]);
            Array.from(allTypes).sort().forEach(type => {
                const count = user.contributions?.[type] || 0;
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between gap-2 bg-gray-50 p-2 rounded';
                div.innerHTML = `
                    <span class="text-sm flex-grow">${type}</span>
                    <input type="number" class="edit-contribution-input w-20 border rounded p-1" data-type="${type}" value="${count}" min="0">
                `;
                ui.editContributionsList.appendChild(div);
            });

            ui.editReportModal.classList.remove('hidden');
        }

        async function refreshVoteCounts() {
            if (!isAdmin) return;
            const promises = votes.map(async (v) => {
                const snap = await getCountFromServer(voteResponsesRef(v.id));
                voteCounts[v.id] = snap.data().count;
            });
            await Promise.all(promises);
            renderVotesAdmin();
        }

        function startListeners() {
             // Zastavíme staré posluchače, pokud existují
            if (unsubscribeConfig) unsubscribeConfig();
            if (unsubscribeQueue) unsubscribeQueue();
            if (unsubscribeVotes) unsubscribeVotes();
            if (unsubscribeVoteResponses) unsubscribeVoteResponses();
            if (unsubscribeHistory) unsubscribeHistory();

            // Votes listener must be role-aware:
            // - Non-admins may only query votes with visible == true (otherwise the whole query is denied).
            // - Admins may query all votes.
            let votesListenerMode = null;
            const startVotesListener = () => {
                const mode = isAdmin ? 'admin' : 'user';
                if (votesListenerMode === mode && unsubscribeVotes) return;
                votesListenerMode = mode;
                if (unsubscribeVotes) unsubscribeVotes();

                const q = isAdmin
                    ? query(votesRef, orderBy('createdAt','desc'))
                    : query(votesRef, where('visible','==', true), orderBy('createdAt','desc'));

                unsubscribeVotes = onSnapshot(q, async (vSnap) => {
                    votes = vSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                    refreshVoteCounts();
                    updateVotingNavVisibility();
                    const active = getActiveVote();
                    // pokud je aktivní hlasování, přepneme se na něj (pokud uživatel nemá vybranou jinou volbu)
                    if (!selectedVoteId && active) selectedVoteId = active.id;
                    if (selectedVoteId && !votes.some(v => v.id === selectedVoteId)) selectedVoteId = active?.id || votes[0]?.id || null;
                    await startVoteResponsesListener(selectedVoteId);
                    renderVoting();
                    renderVotesAdmin();
                }, (err) => {
                    console.error('Votes listener error:', err);
                    showModal('Chyba načítání hlasování: ' + (err?.message || err));
                });
            };

            const startHistoryListener = () => {
                if (!isAdmin) return;
                if (unsubscribeHistory) unsubscribeHistory();
                unsubscribeHistory = onSnapshot(historyRef, (snap) => {
                    historyData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    console.log('History updated:', historyData.length, 'records');
                    renderReports();
                }, (err) => {
                    console.error('History listener error:', err);
                    if (err.message.includes("permission")) {
                         ui.reportsTableBody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-red-600 font-bold">Chyba oprávnění: Kolekce "history" není přístupná. Upravte Firestore Rules.</td></tr>';
                    }
                });
            };
            
            unsubscribeConfig = onSnapshot(configDocRef, (doc) => {
                if (!doc.exists()) return;
                dbState = doc.data() || {};
                const { state = {}, settings = {} } = dbState;

                isAdmin = settings.admins?.includes(currentUser?.email) ?? false;
                setUiForAdmin(isAdmin);

                // (Re)start listeners if admin status changed or if they haven't started yet.
                startVotesListener();
                startHistoryListener();

                renderSettings(settings);
                renderQueue(currentQueue); // re-render s novým nastavením

                const signupsEnabled = settings.signupsEnabled ?? true;
                ui.signupsEnabledToggle.checked = signupsEnabled;
                ui.signupFormContainer.style.display = signupsEnabled ? 'block' : 'none';
                ui.signupsDisabledMessage.style.display = signupsEnabled ? 'none' : 'block';

                const currentSpeaker = state.currentSpeaker;
                ui.currentSpeakerName.textContent = currentSpeaker?.name || '- Nikdo -';
                ui.currentSpeakerTitle.textContent = currentSpeaker?.type || 'Právě mluví';

                const timerState = state.timer || {};
                if (!isDraggingTimer) {
                    timeRemaining = timerState.timeRemaining ?? 0;
                    totalTime = timerState.totalTime ?? 0;
                }
                updateTimerDisplay();

                if (timerState.isRunning && !timerInterval) {
                    timerInterval = setInterval(() => {
                        if (timeRemaining > 0) {
                            timeRemaining--;
                            updateTimerDisplay();
                        } else {
                            if (timerInterval) clearInterval(timerInterval);
                            timerInterval = null;
                            if (dbState.state.timer.isRunning && isAdmin) {
                                advanceToNextSpeaker();
                            }
                        }
                    }, 1000);
                } else if (!timerState.isRunning && timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }

                ui.startTimerBtn.disabled = timerState.isRunning || timeRemaining <= 0 || !state.currentSpeaker;
                ui.pauseTimerBtn.disabled = !timerState.isRunning;
            }, (err) => {
                console.error('Config listener error:', err);
                showModal('Chyba načítání (config): ' + (err?.message || err));
            });

            unsubscribeQueue = onSnapshot(query(queueRef), (qSnap) => {
                currentQueue = qSnap.docs.map(d => ({...d.data(), id: d.id }));
                renderQueue(currentQueue);
            }, (err) => {
                console.error('Queue listener error:', err);
                showModal('Chyba načítání (queue): ' + (err?.message || err));
            });

            // Start votes listener in "user" mode immediately; it will auto-upgrade for admin after config arrives.
            startVotesListener();
            startHistoryListener();
        }
        
        // --- OPRAVENÁ HLAVNÍ FUNKCE ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                ui.authSection.style.display = 'none';
                ui.mainContent.classList.remove('hidden');
                ui.mainContent.classList.add('flex');
                ui.userInfo.textContent = `Přihlášen jako: ${user.displayName || user.email}`;
                ui.speakerNameInput.value = localStorage.getItem('parliamentSpeakerName') || user.displayName || '';
                
                // Zajistíme existenci konfigurace PŘED spuštěním posluchačů
                await ensureMainConfigExists();

                // Spustíme posluchače, kteří načtou data a vykreslí UI
                startListeners();

                switchView('presenter');
            } else {
                currentUser = null;
                isAdmin = false;
                setUiForAdmin(false);
                ui.authSection.style.display = 'block';
                ui.mainContent.classList.add('hidden');
                ui.mainContent.classList.remove('flex');
                // Odpojíme posluchače při odhlášení
                if (unsubscribeConfig) unsubscribeConfig();
                if (unsubscribeQueue) unsubscribeQueue();
                if (unsubscribeVotes) unsubscribeVotes();
                if (unsubscribeVoteResponses) unsubscribeVoteResponses();
                if (unsubscribeHistory) unsubscribeHistory();
            }
        });
        
        ui.loginBtn.addEventListener('click',()=>signInWithPopup(auth,provider).catch(err=>showModal(`Přihlášení selhalo: ${err.message}`)));
        ui.logoutBtn.addEventListener('click',()=>signOut(auth));
        
        ui.navBtns.forEach(b=>b.addEventListener('click',()=>switchView(b.dataset.view)));
        ui.signupBtn.addEventListener('click',async()=>{try{const name=ui.speakerNameInput.value.trim();if(!name) throw new Error("Jméno nesmí být prázdné.");localStorage.setItem('parliamentSpeakerName',name);const isDuplicate=currentQueue.some(s=>s.name.toLowerCase()===name.toLowerCase()&&s.type===selectedContribution);if(isDuplicate){throw new Error(`Řečník <b>${name}</b> je již přihlášen s tímto typem příspěvku.`);}

        await runTransaction(db,async t=>{
            // 1. Všechny TRANSAKČNÍ čtení musí být na začátku (t.get)
            const hDocRef = doc(db, "artifacts", appId, "public", "data", "history", currentUser.uid);
            const [configSnap, hSnap] = await Promise.all([t.get(configDocRef), t.get(hDocRef)]);

            // 2. Ostatní čtení (getDocs - nejsou součástí atomické izolace transakce, ale musí proběhnout před zápisy)
            const typeSetting=dbState.settings?.types.find(s=>s.name===selectedContribution);
            let qSnapSize = 0;
            if(typeSetting?.maxSignups!=null){
                const qSnap=await getDocs(query(queueRef,where("type","==",selectedContribution)));
                qSnapSize = qSnap.size;
            }
            const qDocs = await getDocs(query(queueRef));

            // 3. Logika a kontroly
            if(typeSetting?.maxSignups!=null && qSnapSize >= typeSetting.maxSignups){
                throw new Error(`Byl dosažen maximální počet přihlášek pro tento typ.`);
            }

            // 4. Všechny zápisy musí být na konci (t.set, t.update)

            // Přihlášení (do pořadníku)
            if(qDocs.empty && !configSnap.data().state.currentSpeaker){
                const n=typeSetting?.time??0;
                t.update(configDocRef,{"state.currentSpeaker":{name,type:selectedContribution,party:selectedParty},"state.timer":{timeRemaining:n,totalTime:n,isRunning:false}});
            }else{
                const newSpeakerRef = doc(queueRef);
                t.set(newSpeakerRef, {name,type:selectedContribution,party:selectedParty,timestamp:serverTimestamp()});
            }

            // Historie (agregace)
            let hData = hSnap.exists() ? hSnap.data() : {
                googleName: currentUser.displayName || currentUser.email,
                userNames: [],
                parties: [],
                contributions: {},
                totalCount: 0
            };

            if (!hData.userNames) hData.userNames = [];
            if (!hData.parties) hData.parties = [];
            if (!hData.contributions) hData.contributions = {};

            if (!hData.userNames.includes(name)) hData.userNames.push(name);
            if (selectedParty && !hData.parties.includes(selectedParty)) hData.parties.push(selectedParty);
            hData.totalCount = (hData.totalCount || 0) + 1;
            hData.contributions[selectedContribution] = (hData.contributions[selectedContribution] || 0) + 1;
            hData.googleName = currentUser.displayName || currentUser.email;

            t.set(hDocRef, hData, { merge: true });
        });

        showModal("Úspěšně přihlášen/a.");ui.speakerNameInput.value=localStorage.getItem('parliamentSpeakerName')||currentUser.displayName||'';switchView('presenter');}catch(e){
            let errorMsg = e.message || "Přihlášení selhalo.";
            if (errorMsg.includes("permission")) errorMsg += "<br><br><b>Tip pro administrátora:</b> Je potřeba povolit zápis do kolekce 'history' v Firestore Rules.";
            showModal(errorMsg);
        }});
        
        const handleTileSelection=(container,value,isParty)=>{if(isParty){selectedParty=value; if(value !== null) localStorage.setItem('parliamentPartyName',value);}else{selectedContribution=value;}[...container.children].forEach(t=>t.classList.toggle('selected',t.dataset.name===value));updateSignupButtonState();};
        ui.partyTiles.addEventListener('click',e=>{if(e.target.matches('.tile'))handleTileSelection(ui.partyTiles,e.target.dataset.name,true)});
        ui.contributionTiles.addEventListener('click',e=>{if(e.target.matches('.tile'))handleTileSelection(ui.contributionTiles,e.target.dataset.name,false)});
        ui.speakerNameInput.addEventListener('input', () => {
            localStorage.setItem('parliamentSpeakerName', ui.speakerNameInput.value.trim());
            updateSignupButtonState();
        });

        // Voting UI
        ui.voteYesBtn.addEventListener('click', () => castVote('yes').catch(err => showModal(err?.message || err)));
        ui.voteNoBtn.addEventListener('click', () => castVote('no').catch(err => showModal(err?.message || err)));
        ui.voteAbstainBtn.addEventListener('click', () => castVote('abstain').catch(err => showModal(err?.message || err)));

        ui.voteStyleBtns.forEach(btn => btn.addEventListener('click', () => setVoteStyle(btn.dataset.style)));

	        // Admin: fullscreen results (projection view)
	        if (ui.voteFullscreenBtn) ui.voteFullscreenBtn.addEventListener('click', () => openVoteFullscreen());
	        if (ui.voteFullscreenExitBtn) ui.voteFullscreenExitBtn.addEventListener('click', () => closeVoteFullscreen());
	        document.addEventListener('keydown', (e) => {
	            if (e.key === 'Escape' && ui.voteFullscreenOverlay && !ui.voteFullscreenOverlay.classList.contains('hidden')) {
	                closeVoteFullscreen();
	            }
	        });

        ui.pastVotes.addEventListener('click', (e) => {
            const btn = e.target.closest('button[data-vote-id]');
            if (!btn) return;
            selectVote(btn.dataset.voteId);
        });

        // Admin: add vote
        ui.addVoteBtn.addEventListener('click', async () => {
            if (!isAdmin) return;
            const topic = ui.newVoteTopic.value.trim();
            const total = parseInt(ui.newVoteTotal.value, 10);
            if (!topic) return showModal('Zadejte téma hlasování.');
            if (!Number.isFinite(total) || total <= 0) return showModal('Zadejte platný počet poslanců (> 0).');
            await addDoc(votesRef, { topic, totalMembers: total, active: false, visible: false, secret: false, resultsVisible: false, createdAt: serverTimestamp() });
            ui.newVoteTopic.value = '';
            ui.newVoteTotal.value = '';
        });

        // Admin: manage votes
        ui.votesAdminList.addEventListener('change', async (e) => {
            if (!isAdmin) return;
            const card = e.target.closest('[data-vote-id]');
            const voteId = card?.dataset.voteId;
            if (!voteId) return;
            const ref = voteDocRef(voteId);

            try {
                if (e.target.classList.contains('vote-active-toggle')) {
                    const makeActive = e.target.checked;
                    if (makeActive) {
                        const batch = writeBatch(db);
                        // Vypnout ostatní aktivní a zapnout toto (+ vynutit viditelnost)
                        votes.filter(v => v.active === true && v.id !== voteId).forEach(v => batch.update(voteDocRef(v.id), { active: false }));
                        batch.update(ref, { active: true, visible: true });
                        await batch.commit();
                        selectedVoteId = voteId;
                        await startVoteResponsesListener(voteId);
                    } else {
                        await updateDoc(ref, { active: false });
                    }
                }
                if (e.target.classList.contains('vote-visible-toggle')) {
                    const isVisible = e.target.checked;
                    const updateData = { visible: isVisible };
                    // Pokud vypneme zobrazení, musíme vypnout i aktivitu
                    if (!isVisible) updateData.active = false;
                    await updateDoc(ref, updateData);
                }
                if (e.target.classList.contains('vote-secret-toggle')) {
                    await updateDoc(ref, { secret: e.target.checked });
                }
                if (e.target.classList.contains('vote-results-toggle')) {
                    await updateDoc(ref, { resultsVisible: e.target.checked });
                    refreshVoteCounts();
                }
                if (e.target.classList.contains('vote-total-input')) {
                    const val = parseInt(e.target.value, 10);
                    if (Number.isFinite(val) && val > 0) await updateDoc(ref, { totalMembers: val });
                }
            } catch (err) {
                console.error(err);
                showModal('Nepodařilo se uložit změnu hlasování.');
            }
        });

        ui.votesAdminList.addEventListener('click', async (e) => {
            if (!isAdmin) return;
            const card = e.target.closest('[data-vote-id]');
            const voteId = card?.dataset.voteId;
            if (!voteId) return;

            if (e.target.closest('.delete-vote-btn')) {
                showConfirm('Opravdu chcete smazat toto hlasování? Tato akce je nevratná.', async () => {
                    try {
                        const respSnap = await getDocs(query(voteResponsesRef(voteId)));
                        const batch = writeBatch(db);
                        respSnap.docs.forEach(d => batch.delete(d.ref));
                        batch.delete(voteDocRef(voteId));
                        await batch.commit();
                        if (selectedVoteId === voteId) { selectedVoteId = null; voteResponses = []; }
                        if (openDetailVoteId === voteId) openDetailVoteId = null;
                    } catch (err) {
                        console.error(err);
                        showModal('Nepodařilo se smazat hlasování.');
                    }
                });
                return;
            }

            if (e.target.closest('.reset-vote-btn')) {
                showConfirm('Opravdu chcete resetovat toto hlasování? Všechny odevzdané hlasy budou smazány.', async () => {
                    try {
                        const respSnap = await getDocs(query(voteResponsesRef(voteId)));
                        const batch = writeBatch(db);
                        respSnap.docs.forEach(d => batch.delete(d.ref));
                        await batch.commit();
                        if (selectedVoteId === voteId) { voteResponses = []; renderVoting(); }
                        refreshVoteCounts();
                        showModal('Hlasování bylo resetováno.');
                    } catch (err) {
                        console.error(err);
                        showModal('Nepodařilo se resetovat hlasování.');
                    }
                });
                return;
            }

	            // Detaily
	            if (e.target.closest('.open-vote-details-btn')) {
                    if (openDetailVoteId === voteId) {
                        openDetailVoteId = null;
                        renderVotesAdmin();
                    } else {
                        openDetailVoteId = voteId;
                        renderVotesAdmin();
                        // Po renderu musíme ještě načíst detaily pro ten nový card
                        const newCard = ui.votesAdminList.querySelector(`[data-vote-id="${voteId}"]`);
                        if (newCard) await renderVoteDetails(newCard);
                    }
	                return;
	            }
	            if (e.target.closest('.close-vote-details-btn')) {
                    openDetailVoteId = null;
                    renderVotesAdmin();
	                return;
	            }
	            // Smazat jednotlivý hlas (v detailech)
	            if (e.target.closest('.delete-vote-response-btn')) {
	                try {
	                    const rows = Array.from(card.querySelectorAll('.vote-details-list > div'));
	                    // fallback: zkusíme uid najít podle pořadí v listu (renderVoteDetails drží stejné pořadí)
	                    const idx = Array.from(card.querySelectorAll('.delete-vote-response-btn')).indexOf(e.target.closest('.delete-vote-response-btn'));
	                    const snap = await getDocs(query(voteResponsesRef(voteId), orderBy('updatedAt','desc')));
	                    const docs = snap.docs;
	                    const target = docs[idx];
	                    if (target) await deleteDoc(target.ref);
	                } catch (err) {
	                    console.error(err);
	                    showModal('Nepodařilo se smazat hlas.');
	                }
	                return;
	            }
        });


        ui.addSettingBtn.addEventListener('click',async()=>{const n=ui.newSettingName.value.trim(),t=parseInt(ui.newSettingTime.value),c=ui.newSettingColor.value;if(!n||isNaN(t)||t<=0)return showModal("Zadejte platný název a čas > 0.");const s=[...(dbState.settings?.types||[])];if(s.some(x=>x.name===n))return showModal("Tento typ již existuje.");await updateDoc(configDocRef,{"settings.types":[...s,{name:n,time:t,color:c,maxSignups:null}]});ui.newSettingName.value='';ui.newSettingTime.value='';ui.newSettingColor.value='#FFFFFF'});
        ui.settingsList.addEventListener('input',async e=>{if(!e.target.matches('.setting-color-input, .setting-max-input'))return;const i=parseInt(e.target.dataset.index),s=[...dbState.settings.types];if(e.target.matches('.setting-color-input'))s[i].color=e.target.value;if(e.target.matches('.setting-max-input'))s[i].maxSignups=e.target.value===''?null:parseInt(e.target.value,10);if(!isNaN(s[i].maxSignups))await updateDoc(configDocRef,{"settings.types":s})});
        ui.settingsList.addEventListener('click',async e=>{if(e.target.classList.contains('remove-setting-btn')){const n=e.target.dataset.name;await updateDoc(configDocRef,{"settings.types":dbState.settings.types.filter(s=>s.name!==n)})}});
        ui.addPartyBtn.addEventListener('click',async()=>{const n=ui.newPartyNameInput.value.trim();if(!n)return;const p=[...(dbState.settings?.parties||[])];if(p.some(x=>x.name===n))return showModal("Tato strana již existuje.");await updateDoc(configDocRef,{"settings.parties":[...p,{name:n}]});ui.newPartyNameInput.value=''});
        ui.partiesList.addEventListener('click',async e=>{if(e.target.classList.contains('remove-party-btn')){const n=e.target.dataset.name;await updateDoc(configDocRef,{"settings.parties":dbState.settings.parties.filter(p=>p.name!==n)})}});
        $$('.collapsible-trigger').forEach(t=>t.addEventListener('click',()=>{const content=t.nextElementSibling;content.classList.toggle('hidden');t.querySelector('i').classList.toggle('rotate-180')}));
        ui.adminSpeakerList.addEventListener('click',e=>{if(isAdmin&&e.target.matches('.remove-speaker-btn'))deleteDoc(doc(queueRef,e.target.dataset.id))});
        ui.speakerQueueList.addEventListener('click',e=>{if(isAdmin&&e.target.closest('#next-speaker-tile'))advanceToNextSpeaker()});
        ui.nextSpeakerBtn.addEventListener('click',advanceToNextSpeaker);
        ui.startTimerBtn.addEventListener('click',()=>updateDoc(configDocRef,{"state.timer.isRunning":true}));
        ui.pauseTimerBtn.addEventListener('click',()=>updateDoc(configDocRef,{"state.timer.isRunning":false,"state.timer.timeRemaining":timeRemaining}));
        ui.resetTimerBtn.addEventListener('click',resetTimer);
        ui.signupsEnabledToggle.addEventListener('change',e=>updateDoc(configDocRef,{"settings.signupsEnabled":e.target.checked}));
        ui.partiesEnabledToggle.addEventListener('change',e=>updateDoc(configDocRef,{"settings.partiesEnabled":e.target.checked}));
        ui.fullscreenBtn.addEventListener('click', () => { document.body.classList.add('fullscreen'); document.documentElement.requestFullscreen(); });
        ui.exitFullscreenBtn.addEventListener('click', () => { document.body.classList.remove('fullscreen'); document.exitFullscreen(); });
        ui.qrToggleBtn.addEventListener('click', () => { ui.qrContainer.classList.toggle('hidden'); });
        document.addEventListener('fullscreenchange', () => { if (!document.fullscreenElement) document.body.classList.remove('fullscreen'); });
        ui.addAdminBtn.addEventListener('click',async()=>{const e=ui.newAdminEmail.value.trim();if(!e)return;const a=[...(dbState.settings?.admins||[])];if(a.includes(e))return showModal("Tento uživatel již je administrátor.");await updateDoc(configDocRef,{"settings.admins":[...a,e]});ui.newAdminEmail.value=''});
        ui.adminsList.addEventListener('click',async e=>{if(e.target.classList.contains('remove-admin-btn')){const t=e.target.dataset.email;await updateDoc(configDocRef,{"settings.admins":dbState.settings.admins.filter(a=>a!==t)})}});
        let draggedItem=null;ui.settingsList.addEventListener('dragstart',e=>{draggedItem=e.target;setTimeout(()=>e.target.classList.add('dragging'),0)});ui.settingsList.addEventListener('dragend',e=>e.target.classList.remove('dragging'));ui.settingsList.addEventListener('dragover',e=>{e.preventDefault();const a=getDragAfterElement(ui.settingsList,e.clientY);if(a==null){ui.settingsList.appendChild(draggedItem)}else{ui.settingsList.insertBefore(draggedItem,a)}});
        ui.settingsList.addEventListener('drop',async e=>{e.preventDefault();if(!draggedItem)return;draggedItem.classList.remove('dragging');const n=[...ui.settingsList.querySelectorAll('.setting-item')].map(i=>i.dataset.name),s=n.map(name=>dbState.settings.types.find(x=>x.name===name)).filter(Boolean);await updateDoc(configDocRef,{'settings.types':s});draggedItem=null;});
        function getDragAfterElement(c,y){const d=[...c.querySelectorAll('.setting-item:not(.dragging)')];return d.reduce((closest,child)=>{const b=child.getBoundingClientRect(),o=y-b.top-b.height/2;return(o<0&&o>closest.offset)?{offset:o,element:child}:closest},{offset:Number.NEGATIVE_INFINITY}).element}
        const handleTimerDrag=(e)=>{if(!isDraggingTimer||totalTime<=0||!isAdmin)return;e.preventDefault();const r=ui.timerDisplay.getBoundingClientRect(),x=e.touches?e.touches[0].clientX:e.clientX,y=e.touches?e.touches[0].clientY:e.clientY,a=Math.atan2(y-(r.top+r.height/2),x-(r.left+r.width/2))+Math.PI/2;timeRemaining=Math.round((a<0?a+2*Math.PI:a)/(2*Math.PI)*totalTime);updateTimerDisplay()};
        const startDrag=(e)=>{if(e.target.closest('#time-left') && totalTime>0&&isAdmin){isDraggingTimer=true;ui.timerDisplay.style.cursor='grabbing';if(dbState.state?.timer?.isRunning)updateDoc(configDocRef,{"state.timer.isRunning":false})}};
        const stopDrag=()=>{if(isDraggingTimer&&isAdmin){isDraggingTimer=false;ui.timerDisplay.style.cursor='grab';updateDoc(configDocRef,{"state.timer.timeRemaining":timeRemaining})}};
        ui.timerDisplay.addEventListener('mousedown',startDrag);document.addEventListener('mousemove',handleTimerDrag);document.addEventListener('mouseup',stopDrag);ui.timerDisplay.addEventListener('touchstart',startDrag,{passive:false});document.addEventListener('touchmove',handleTimerDrag,{passive:false});document.addEventListener('touchend',stopDrag);

        ui.editReportSaveBtn.addEventListener('click', async () => {
            if (!currentlyEditingUserId) return;
            const contributions = {};
            let totalCount = 0;
            ui.editContributionsList.querySelectorAll('.edit-contribution-input').forEach(input => {
                const count = parseInt(input.value) || 0;
                contributions[input.dataset.type] = count;
                totalCount += count;
            });

            const updatedData = {
                googleName: ui.editGoogleName.value.trim(),
                userNames: ui.editUserNames.value.split('\n').map(s => s.trim()).filter(Boolean),
                parties: ui.editParties.value.split('\n').map(s => s.trim()).filter(Boolean),
                contributions: contributions,
                totalCount: totalCount
            };

            try {
                await setDoc(doc(db, "artifacts", appId, "public", "data", "history", currentlyEditingUserId), updatedData);
                ui.editReportModal.classList.add('hidden');
            } catch (err) {
                console.error(err);
                showModal('Nepodařilo se uložit změny.');
            }
        });

        ui.editReportCancelBtn.addEventListener('click', () => ui.editReportModal.classList.add('hidden'));

        ui.deleteReportRowBtn.addEventListener('click', () => {
            if (!currentlyEditingUserId) return;
            showConfirm("Opravdu chcete smazat celý tento záznam?", async () => {
                try {
                    await deleteDoc(doc(db, "artifacts", appId, "public", "data", "history", currentlyEditingUserId));
                    ui.editReportModal.classList.add('hidden');
                } catch (err) {
                    console.error(err);
                    showModal('Nepodařilo se smazat záznam.');
                }
            });
        });

        ui.printReportsBtn.addEventListener('click', () => window.print());

        ui.resetHistoryBtn.addEventListener('click', () => {
            showConfirm("Opravdu chcete vymazat CELOU historii přihlašování? Tato akce je nevratná.", async () => {
                try {
                    const snap = await getDocs(historyRef);
                    const batch = writeBatch(db);
                    snap.docs.forEach(d => batch.delete(d.ref));
                    await batch.commit();
                } catch (err) {
                    console.error(err);
                    showModal('Nepodařilo se vymazat historii.');
                }
            });
        });
    </script>
</body>
</html>
