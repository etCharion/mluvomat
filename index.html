<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parlamentní Pořadník</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { font-family: 'Inter', sans-serif; display: flex; flex-direction: column; }
        #app { width: 100%; max-width: 1400px; margin-left: auto; margin-right: auto; padding: 1rem; flex-grow: 1; display: flex; flex-direction: column; min-height: 0; }
        .view { display: none; flex-grow: 1; min-height: 0; }
        .active-view { display: flex; flex-direction: column; min-height: 0; }
        .scrollable-list-container { display: flex; flex-direction: column; min-height: 0; flex-grow: 1; }
        .scrollable-list { overflow-y: auto; flex-grow: 1; }
        .timer-ring { stroke-dasharray: 283; stroke-dashoffset: 283; transition: stroke-dashoffset 0.2s linear; }
        #timer-display { touch-action: none; cursor: grab; }
        input[type="color"] { -webkit-appearance: none; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 1px solid #ccc; border-radius: 8px; }
        .setting-item.dragging { opacity: 0.5; }
        .toggle-checkbox { display: none; }
        .toggle-label { display: block; width: 40px; height: 20px; background-color: #e2e8f0; border-radius: 9999px; position: relative; transition: background-color 0.2s; cursor: pointer; }
        .toggle-label .dot { position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background: white; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .toggle-checkbox:checked + .toggle-label { background-color: #48BB78; }
        .toggle-checkbox:checked + .toggle-label .dot { transform: translateX(20px); }
        .tile { border: 2px solid transparent; transition: all 0.2s ease-in-out; }
        .tile.selected { border-color: #3B82F6; box-shadow: 0 0 0 2px #3B82F6; }
        body.fullscreen #main-header { display: none; }
        body.fullscreen #app { padding: 0; max-width: 100%;}
        body.fullscreen #presenter-view { border-radius: 0; height: 100vh; }
        #exit-fullscreen-btn { display: none; }
        body.fullscreen #exit-fullscreen-btn { display: block; }
        body.fullscreen #fullscreen-btn { display: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

<div id="app">
    <!-- Auth Section -->
    <div id="auth-section" class="text-center p-8 bg-white rounded-lg shadow-md m-auto">
        <h1 class="text-3xl font-bold mb-4">Parlamentní Pořadník</h1>
        <p class="text-gray-600 mb-6">Pro pokračování se prosím přihlaste.</p>
        <button id="login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">
            <i class="fab fa-google mr-2"></i> Přihlásit se Google účtem
        </button>
    </div>

    <!-- Main Content -->
    <div id="main-content" style="display: none;" class="flex-col h-full">
        <!-- Header -->
        <header id="main-header" class="flex items-center justify-between p-4 bg-white rounded-t-lg shadow">
            <h1 class="text-2xl font-bold text-gray-800">Parlamentní Pořadník</h1>
            <div class="flex items-center space-x-4">
                <div id="user-info" class="flex items-center space-x-3">
                    <img id="user-avatar" class="w-10 h-10 rounded-full" src="" alt="User Avatar">
                    <div>
                        <p id="user-name" class="font-semibold text-sm"></p>
                        <p id="user-email" class="text-xs text-gray-500"></p>
                    </div>
                </div>
                 <button id="fullscreen-btn" class="text-gray-600 hover:text-blue-600"><i class="fas fa-expand fa-fw"></i></button>
                 <button id="exit-fullscreen-btn" class="text-gray-600 hover:text-blue-600"><i class="fas fa-compress fa-fw"></i></button>
                <button id="settings-btn" class="text-gray-600 hover:text-blue-600"><i class="fas fa-cog fa-fw"></i></button>
                <button id="logout-btn" class="text-gray-600 hover:text-red-600"><i class="fas fa-sign-out-alt fa-fw"></i></button>
            </div>
        </header>

        <!-- Views Container -->
        <main class="flex-grow flex min-h-0 bg-gray-100 rounded-b-lg">
             <!-- User View -->
            <div id="user-view" class="w-1/3 p-4 border-r border-gray-200 view active-view">
                <div class="scrollable-list-container">
                    <h2 class="text-xl font-bold mb-4">Fronta řečníků</h2>
                    <ul id="queue-list" class="space-y-3 scrollable-list pr-2"></ul>
                </div>
                <div id="signup-section" class="mt-4 pt-4 border-t border-gray-200">
                     <h3 class="text-lg font-semibold mb-3">Přihlásit se o slovo</h3>
                     <div id="signup-types" class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-3"></div>
                     <button id="signup-btn" disabled class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        Přihlásit se
                    </button>
                </div>
            </div>

            <!-- Presenter View -->
            <div id="presenter-view" class="flex-grow p-6 flex flex-col items-center justify-center text-center bg-white view active-view">
                <div id="current-speaker-info" class="mb-8">
                     <h2 id="current-speaker-name" class="text-5xl font-bold text-gray-800">Nikdo nemluví</h2>
                     <p id="current-speaker-type" class="text-2xl text-gray-500 mt-2"></p>
                </div>
                <div id="timer-container" class="relative">
                    <svg class="transform -rotate-90" width="300" height="300" viewBox="0 0 100 100">
                        <circle class="text-gray-200" stroke-width="5" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                        <circle id="timer-ring-circle" class="timer-ring text-blue-500" stroke-width="5" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                    </svg>
                    <div id="timer-display" class="absolute inset-0 flex items-center justify-center text-6xl font-bold tabular-nums">03:00</div>
                </div>
                <div id="admin-controls" class="mt-8 flex space-x-4">
                    <button id="prev-speaker-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-full"><i class="fas fa-backward"></i></button>
                    <button id="toggle-timer-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full w-32"><i class="fas fa-play"></i> Start</button>
                    <button id="next-speaker-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-full"><i class="fas fa-forward"></i></button>
                </div>
            </div>
            
            <!-- Settings View -->
            <div id="settings-view" class="w-full p-6 bg-white view">
                 <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold">Nastavení</h2>
                    <button id="close-settings-btn" class="text-gray-500 hover:text-gray-800"><i class="fas fa-times fa-lg"></i></button>
                </div>
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- General Settings -->
                    <div>
                        <h3 class="text-lg font-semibold mb-4 border-b pb-2">Obecné</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <label for="signups-enabled" class="font-medium">Povolit přihlašování</label>
                                <input type="checkbox" id="signups-enabled" class="toggle-checkbox setting-input" data-key="signupsEnabled"><label for="signups-enabled" class="toggle-label"><span class="dot"></span></label>
                            </div>
                             <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <label for="parties-enabled" class="font-medium">Používat politické strany</label>
                                <input type="checkbox" id="parties-enabled" class="toggle-checkbox setting-input" data-key="partiesEnabled"><label for="parties-enabled" class="toggle-label"><span class="dot"></span></label>
                            </div>
                        </div>
                    </div>
                    <!-- Admins -->
                    <div>
                         <h3 class="text-lg font-semibold mb-4 border-b pb-2">Administrátoři</h3>
                         <div id="admin-list" class="space-y-2"></div>
                         <div class="mt-3 flex">
                            <input type="email" id="new-admin-email" placeholder="Email nového admina" class="flex-grow p-2 border rounded-l-md focus:ring-blue-500 focus:border-blue-500">
                            <button id="add-admin-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold p-2 rounded-r-md">Přidat</button>
                         </div>
                    </div>
                     <!-- Types of Contributions -->
                    <div class="lg:col-span-2">
                        <h3 class="text-lg font-semibold mb-4 border-b pb-2">Typy příspěvků</h3>
                        <div id="types-list" class="space-y-3"></div>
                        <button id="add-type-btn" class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg w-full">Přidat nový typ</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, deleteDoc, runTransaction, updateDoc, query, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // --- OPRAVA: Hardcoded Firebase Config ---
    const firebaseConfig = {
        apiKey: "AIzaSyAyAXoqQA8SbBe2-ilDSKNoHPmTengxlEY",
        authDomain: "mluvomat.firebaseapp.com",
        projectId: "mluvomat",
        storageBucket: "mluvomat.appspot.com",
        messagingSenderId: "399583547545",
        appId: "1:399583547545:web:4e3e45b7cc952dc567e808"
    };
    if (!firebaseConfig.apiKey) {
        document.getElementById('auth-section').innerHTML = `<h1 class="text-2xl font-bold text-red-600 mb-4">Chyba Konfigurace</h1><p class="text-gray-600">Konfigurace Firebase nebyla nalezena.</p>`;
    }

    // --- Basic Setup ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();
    const appId = 'parliament-app-default';

    // Firestore References
    const configDocRef = doc(db, "artifacts", appId, "public/data/config", "main");
    const queueRef = collection(db, "artifacts", appId, "public/data/queue");

    // Global state
    let currentUser = null;
    let isAdmin = false;
    let config = null;
    let queue = [];
    let timerInterval = null;
    let selectedSignupType = null;
    let currentTimerState = { timeRemaining: 0, totalTime: 0, isRunning: false };
    
    // UI Elements
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const authSection = document.getElementById('auth-section');
    const mainContent = document.getElementById('main-content');
    const userInfo = document.getElementById('user-info');
    const userAvatar = document.getElementById('user-avatar');
    const userName = document.getElementById('user-name');
    const userEmail = document.getElementById('user-email');
    const settingsBtn = document.getElementById('settings-btn');
    const closeSettingsBtn = document.getElementById('close-settings-btn');
    const userView = document.getElementById('user-view');
    const presenterView = document.getElementById('presenter-view');
    const settingsView = document.getElementById('settings-view');
    const queueList = document.getElementById('queue-list');
    const signupSection = document.getElementById('signup-section');
    const signupTypesContainer = document.getElementById('signup-types');
    const signupBtn = document.getElementById('signup-btn');
    const currentSpeakerName = document.getElementById('current-speaker-name');
    const currentSpeakerType = document.getElementById('current-speaker-type');
    const timerDisplay = document.getElementById('timer-display');
    const timerRing = document.getElementById('timer-ring-circle');
    const adminControls = document.getElementById('admin-controls');
    const prevSpeakerBtn = document.getElementById('prev-speaker-btn');
    const toggleTimerBtn = document.getElementById('toggle-timer-btn');
    const nextSpeakerBtn = document.getElementById('next-speaker-btn');
    const settingsInputs = document.querySelectorAll('.setting-input');
    const addAdminBtn = document.getElementById('add-admin-btn');
    const adminList = document.getElementById('admin-list');
    const typesList = document.getElementById('types-list');
    const addTypeBtn = document.getElementById('add-type-btn');
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    const exitFullscreenBtn = document.getElementById('exit-fullscreen-btn');


    // --- OPRAVENÁ FUNKCE: Inicializace configu a přidání admina pokud chybí ---
    async function ensureMainConfigExistsAndAddAdminIfMissing() {
        const userEmail = auth.currentUser?.email;
        if (!userEmail) return;

        try {
            await runTransaction(db, async (transaction) => {
                const docSnap = await transaction.get(configDocRef);
                if (!docSnap.exists()) {
                     const defaultConfig = {
                        settings: {
                            signupsEnabled: true,
                            partiesEnabled: false,
                            admins: [userEmail], // První uživatel se stává adminem
                            types: [
                                { name: "Standardní", time: 180, color: "#3B82F6" },
                                { name: "Reakce", time: 60, color: "#FBBF24" },
                                { name: "Faktická", time: 30, color: "#EF4444" }
                            ],
                            parties: [
                                { name: "Vládní strana" },
                                { name: "Opoziční strana" }
                            ]
                        },
                        state: {
                            currentSpeakerId: null,
                            timer: { timeRemaining: 180, totalTime: 180, isRunning: false }
                        }
                    };
                    transaction.set(configDocRef, defaultConfig);
                    console.log("Config document created for the first time.");
                } else {
                    const existingConfig = docSnap.data();
                    const admins = existingConfig.settings?.admins || [];
                    if (!admins.includes(userEmail)) {
                        const newAdmins = [...admins, userEmail];
                        transaction.update(configDocRef, { "settings.admins": newAdmins });
                        console.log(`User ${userEmail} added as an admin.`);
                    }
                }
            });
        } catch (error) {
            console.error("Error ensuring config exists: ", error);
            // Zobrazit chybu uživateli
        }
    }
    
    // --- HLAVNÍ: onAuthStateChanged s opravou ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            authSection.style.display = 'none';
            mainContent.style.display = 'flex';
            
            // Nastaví info o uživateli v UI
            userAvatar.src = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName}&background=random`;
            userName.textContent = user.displayName;
            userEmail.textContent = user.email;

            // DŮLEŽITÉ: Zavolá inicializaci configu.
            await ensureMainConfigExistsAndAddAdminIfMissing();

            // Nastartuje posluchače na změny v databázi
            startListeners();
            
        } else {
            currentUser = null;
            isAdmin = false;
            authSection.style.display = 'block';
            mainContent.style.display = 'none';
            // Zastavit posluchače pokud existují
            if(unsubscribeConfig) unsubscribeConfig();
            if(unsubscribeQueue) unsubscribeQueue();
        }
    });

    // --- Authentication ---
    loginBtn.addEventListener('click', () => {
        signInWithPopup(auth, provider).catch(error => console.error("Login failed:", error));
    });

    logoutBtn.addEventListener('click', () => {
        signOut(auth).catch(error => console.error("Logout failed:", error));
    });

    // --- Listeners ---
    let unsubscribeConfig, unsubscribeQueue;

    function startListeners() {
        // Stop previous listeners if they exist
        if (unsubscribeConfig) unsubscribeConfig();
        if (unsubscribeQueue) unsubscribeQueue();

        // Listener for config changes
        unsubscribeConfig = onSnapshot(configDocRef, (doc) => {
            if (doc.exists()) {
                config = doc.data();
                isAdmin = config.settings.admins.includes(currentUser.email);
                currentTimerState = config.state.timer;
                renderAll();
            }
        }, (error) => console.error("Error listening to config:", error));

        // Listener for queue changes
        const q = query(queueRef);
        unsubscribeQueue = onSnapshot(q, (querySnapshot) => {
            queue = [];
            querySnapshot.forEach((doc) => {
                queue.push({ id: doc.id, ...doc.data() });
            });
            renderQueue();
            updateAdminControls();
        }, (error) => console.error("Error listening to queue:", error));
    }

    // --- Rendering ---
    function renderAll() {
        if (!config || !currentUser) return;
        renderQueue();
        renderPresenter();
        renderSignupOptions();
        updateAdminUI();
        updateTimerDisplay();
    }
    
    function renderQueue() {
        queueList.innerHTML = '';
        const currentSpeakerId = config?.state?.currentSpeakerId;

        queue.forEach((speaker, index) => {
            const isCurrent = speaker.id === currentSpeakerId;
            const li = document.createElement('li');
            li.className = `p-3 rounded-lg flex items-center justify-between transition-all duration-200 ${isCurrent ? 'bg-blue-100 ring-2 ring-blue-500' : 'bg-white shadow-sm'}`;
            
            const typeInfo = config.settings.types.find(t => t.name === speaker.type) || { color: '#CCCCCC' };
            
            li.innerHTML = `
                <div class="flex items-center">
                    <span class="font-bold text-lg text-gray-700 w-8">${index + 1}.</span>
                    <div class="w-2 h-8 rounded-full" style="background-color: ${typeInfo.color}; margin-right: 12px;"></div>
                    <div>
                        <p class="font-semibold text-gray-900">${speaker.name}</p>
                        <p class="text-sm text-gray-500">${speaker.type}</p>
                    </div>
                </div>
                ${isAdmin ? `<button data-id="${speaker.id}" class="remove-speaker-btn text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>` : ''}
            `;
            queueList.appendChild(li);
        });

        // Add event listeners to remove buttons
        document.querySelectorAll('.remove-speaker-btn').forEach(button => {
            button.addEventListener('click', () => removeSpeaker(button.dataset.id));
        });
    }

    function renderPresenter() {
        const currentSpeakerId = config?.state?.currentSpeakerId;
        const currentSpeaker = queue.find(s => s.id === currentSpeakerId);

        if (currentSpeaker) {
            currentSpeakerName.textContent = currentSpeaker.name;
            currentSpeakerType.textContent = currentSpeaker.type;
        } else {
            currentSpeakerName.textContent = "Nikdo nemluví";
            currentSpeakerType.textContent = "Fronta je prázdná";
        }
    }
    
    function renderSignupOptions() {
        signupTypesContainer.innerHTML = '';
        if(!config.settings.signupsEnabled) {
            signupSection.style.display = 'none';
            return;
        }
        
        signupSection.style.display = 'block';
        const alreadySignedUp = queue.some(s => s.uid === currentUser.uid);

        if(alreadySignedUp) {
             signupTypesContainer.innerHTML = `<div class="text-center col-span-2 p-3 bg-green-100 text-green-800 rounded-lg">Už jsi přihlášený.</div>`;
             signupBtn.disabled = true;
             signupBtn.textContent = 'Již přihlášen';
             return;
        }


        config.settings.types.forEach(type => {
            const button = document.createElement('button');
            button.className = 'tile p-3 bg-white rounded-lg text-left shadow-sm';
            button.dataset.typeName = type.name;
            const typeColor = type.color || '#3B82F6';
            
            button.innerHTML = `
                <div class="flex items-center">
                    <div class="w-2 h-8 rounded-full" style="background-color: ${typeColor}; margin-right: 12px;"></div>
                    <div>
                        <p class="font-semibold">${type.name}</p>
                        <p class="text-sm text-gray-600">${type.time / 60} min</p>
                    </div>
                </div>
            `;
            
            button.addEventListener('click', () => {
                selectedSignupType = type.name;
                document.querySelectorAll('#signup-types .tile').forEach(t => t.classList.remove('selected'));
                button.classList.add('selected');
                signupBtn.disabled = false;
            });

            signupTypesContainer.appendChild(button);
        });
    }


    function updateAdminUI() {
        adminControls.style.display = isAdmin ? 'flex' : 'none';
        settingsBtn.style.display = isAdmin ? 'block' : 'none';
    }

    function updateTimerDisplay() {
        const { timeRemaining, isRunning } = currentTimerState;
        const totalTime = currentTimerState.totalTime || 1; // Avoid division by zero
        
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        
        const progress = (totalTime - timeRemaining) / totalTime;
        const dashOffset = 283 * (1 - progress);
        timerRing.style.strokeDashoffset = dashOffset;
        
        toggleTimerBtn.innerHTML = isRunning ? '<i class="fas fa-pause"></i> Pauza' : '<i class="fas fa-play"></i> Start';
        toggleTimerBtn.classList.toggle('bg-yellow-500', isRunning);
        toggleTimerBtn.classList.toggle('hover:bg-yellow-600', isRunning);
        toggleTimerBtn.classList.toggle('bg-blue-500', !isRunning);
        toggleTimerBtn.classList.toggle('hover:bg-blue-600', !isRunning);

        // Change ring color based on time
        if (timeRemaining <= 10) timerRing.classList.add('text-red-500');
        else if (timeRemaining <= 30) timerRing.classList.add('text-yellow-500');
        else {
            const currentSpeakerId = config?.state?.currentSpeakerId;
            const currentSpeaker = queue.find(s => s.id === currentSpeakerId);
            if (currentSpeaker) {
                const typeInfo = config.settings.types.find(t => t.name === currentSpeaker.type);
                timerRing.style.color = typeInfo?.color || '#3B82F6';
            } else {
                 timerRing.style.color = '#3B82F6';
            }
            timerRing.classList.remove('text-red-500', 'text-yellow-500');
        }

    }
    
    function updateAdminControls() {
        const currentSpeakerIndex = queue.findIndex(s => s.id === config.state.currentSpeakerId);
        prevSpeakerBtn.disabled = currentSpeakerIndex <= 0;
        nextSpeakerBtn.disabled = currentSpeakerIndex >= queue.length - 1 && config.state.currentSpeakerId !== null;
    }
    

    // --- Actions ---
    signupBtn.addEventListener('click', async () => {
        if (!selectedSignupType || !currentUser) return;

        const alreadySignedUp = queue.some(s => s.uid === currentUser.uid);
        if(alreadySignedUp) {
            alert("Už jsi ve frontě!");
            return;
        }

        const newSpeaker = {
            uid: currentUser.uid,
            name: currentUser.displayName,
            email: currentUser.email,
            type: selectedSignupType,
            timestamp: new Date()
        };

        try {
            await addDoc(queueRef, newSpeaker);
            console.log("Signed up successfully");
            selectedSignupType = null; // Reset selection
            signupBtn.disabled = true;
            document.querySelectorAll('#signup-types .tile').forEach(t => t.classList.remove('selected'));

        } catch (error) {
            console.error("Error signing up: ", error);
        }
    });

    async function removeSpeaker(speakerId) {
        if (!isAdmin) return;
        try {
            // If deleting the current speaker, advance to the next one automatically
            if(config.state.currentSpeakerId === speakerId) {
                await setNextSpeaker();
            }
            await deleteDoc(doc(db, "artifacts", appId, "public/data/queue", speakerId));
        } catch (error) {
            console.error("Error removing speaker: ", error);
        }
    }
    
     async function setNextSpeaker(previous = false) {
        if (!isAdmin) return;

        const currentSpeakerId = config.state.currentSpeakerId;
        const currentIndex = queue.findIndex(s => s.id === currentSpeakerId);
        
        let nextIndex;
        if (currentSpeakerId === null) {
            nextIndex = 0; // Start with the first person if no one is speaking
        } else {
            nextIndex = previous ? currentIndex - 1 : currentIndex + 1;
        }
        
        const nextSpeaker = queue[nextIndex];

        if (nextSpeaker) {
            const typeInfo = config.settings.types.find(t => t.name === nextSpeaker.type);
            const newTime = typeInfo ? typeInfo.time : 180;
            const newState = {
                "state.currentSpeakerId": nextSpeaker.id,
                "state.timer.timeRemaining": newTime,
                "state.timer.totalTime": newTime,
                "state.timer.isRunning": false
            };
            await updateDoc(configDocRef, newState);
        } else {
            // End of queue
            const newState = {
                "state.currentSpeakerId": null,
                "state.timer.isRunning": false
            };
            await updateDoc(configDocRef, newState);
        }
    }

    nextSpeakerBtn.addEventListener('click', () => setNextSpeaker(false));
    prevSpeakerBtn.addEventListener('click', () => setNextSpeaker(true));
    
    toggleTimerBtn.addEventListener('click', () => {
        if (!isAdmin || !config.state.currentSpeakerId) return;
        updateDoc(configDocRef, { "state.timer.isRunning": !config.state.timer.isRunning });
    });
    
    // --- Timer Logic (client-side prediction) ---
    setInterval(() => {
        if (currentTimerState.isRunning && currentTimerState.timeRemaining > 0) {
            currentTimerState.timeRemaining--;
            updateTimerDisplay();
        } else if (currentTimerState.isRunning && currentTimerState.timeRemaining <= 0) {
            // Stop timer when it hits 0
            currentTimerState.isRunning = false;
            if(isAdmin) updateDoc(configDocRef, { "state.timer.isRunning": false });
        }
    }, 1000);


    // --- Settings View Logic ---
    function showSettings() {
        // First, render the current settings before showing the view
        renderSettings();
        userView.classList.remove('active-view');
        presenterView.classList.remove('active-view');
        settingsView.classList.add('active-view');
        settingsBtn.classList.add('text-blue-600');
    }

    function hideSettings() {
        settingsView.classList.remove('active-view');
        userView.classList.add('active-view');
        presenterView.classList.add('active-view');
        settingsBtn.classList.remove('text-blue-600');
    }
    
    settingsBtn.addEventListener('click', showSettings);
    closeSettingsBtn.addEventListener('click', hideSettings);
    
    function renderSettings() {
        if (!config || !isAdmin) return;
        
        // General settings
        document.getElementById('signups-enabled').checked = config.settings.signupsEnabled;
        document.getElementById('parties-enabled').checked = config.settings.partiesEnabled;

        // Admins
        adminList.innerHTML = '';
        config.settings.admins.forEach(email => {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-2 bg-gray-100 rounded-md';
            div.innerHTML = `
                <span>${email}</span>
                ${config.settings.admins.length > 1 ? `<button data-email="${email}" class="remove-admin-btn text-red-400 hover:text-red-600 text-sm"><i class="fas fa-times"></i></button>` : ''}
            `;
            adminList.appendChild(div);
        });
        
        // Types
        typesList.innerHTML = '';
        config.settings.types.forEach((type, index) => {
             const div = document.createElement('div');
             div.className = 'setting-item p-3 bg-gray-100 rounded-lg space-y-2';
             div.innerHTML = `
                <div class="grid grid-cols-12 gap-x-3 items-center">
                    <span class="col-span-1 text-gray-400"><i class="fas fa-grip-vertical"></i></span>
                    <input type="text" value="${type.name}" data-index="${index}" data-field="name" class="type-input col-span-5 p-1 border rounded bg-white">
                    <input type="number" value="${type.time}" data-index="${index}" data-field="time" class="type-input col-span-2 p-1 border rounded bg-white w-20 text-center">
                    <input type="color" value="${type.color}" data-index="${index}" data-field="color" class="type-input col-span-2 p-0 border-none">
                    <div class="col-span-2 flex justify-end">
                      <button data-index="${index}" class="remove-type-btn text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
             `;
             typesList.appendChild(div);
        });

        // Add event listeners for settings controls
        addEventListenersForSettings();
    }
    
    function addEventListenersForSettings() {
        document.querySelectorAll('.remove-admin-btn').forEach(btn => btn.onclick = (e) => updateAdminList(e.currentTarget.dataset.email, 'remove'));
        document.querySelectorAll('.type-input').forEach(input => input.onchange = (e) => updateType(e.currentTarget));
        document.querySelectorAll('.remove-type-btn').forEach(btn => btn.onclick = (e) => updateTypeList(parseInt(e.currentTarget.dataset.index), 'remove'));
    }
    
    addAdminBtn.addEventListener('click', () => {
        const emailInput = document.getElementById('new-admin-email');
        if (emailInput.value) {
            updateAdminList(emailInput.value, 'add');
            emailInput.value = '';
        }
    });

    addTypeBtn.addEventListener('click', () => updateTypeList(null, 'add'));
    
    settingsInputs.forEach(input => {
        input.addEventListener('change', async (e) => {
            if(!isAdmin) return;
            const key = e.target.dataset.key;
            const value = e.target.checked;
            try {
                await updateDoc(configDocRef, { [`settings.${key}`]: value });
            } catch (error) {
                console.error("Error updating setting:", error);
            }
        });
    });

    async function updateAdminList(email, action) {
        if(!isAdmin) return;
        const currentAdmins = config.settings.admins || [];
        let newAdmins;
        if (action === 'add' && !currentAdmins.includes(email)) {
            newAdmins = [...currentAdmins, email];
        } else if (action === 'remove') {
            newAdmins = currentAdmins.filter(a => a !== email);
        } else {
            return; // No change
        }
        
        try {
            await updateDoc(configDocRef, { 'settings.admins': newAdmins });
        } catch (error) {
            console.error("Error updating admin list:", error);
        }
    }

    async function updateTypeList(index, action) {
        if(!isAdmin) return;
        let newTypes = [...config.settings.types];
        if(action === 'add') {
            newTypes.push({ name: "Nový typ", time: 120, color: "#808080"});
        } else if (action === 'remove') {
            newTypes.splice(index, 1);
        }
        
        try {
            await updateDoc(configDocRef, { 'settings.types': newTypes });
        } catch(error) {
            console.error("Error updating types list:", error);
        }
    }

    async function updateType(inputElement) {
        if(!isAdmin) return;
        const index = parseInt(inputElement.dataset.index);
        const field = inputElement.dataset.field;
        const value = field === 'time' ? parseInt(inputElement.value) : inputElement.value;
        
        let newTypes = [...config.settings.types];
        newTypes[index][field] = value;

        try {
             await updateDoc(configDocRef, { 'settings.types': newTypes });
        } catch(error) {
            console.error("Error updating type detail:", error);
        }
    }

    // Fullscreen logic
    function enterFullscreen() {
        document.body.classList.add('fullscreen');
        if (document.documentElement.requestFullscreen) {
            document.documentElement.requestFullscreen();
        } else if (document.documentElement.webkitRequestFullscreen) { /* Safari */
            document.documentElement.webkitRequestFullscreen();
        }
    }

    function exitFullscreen() {
        document.body.classList.remove('fullscreen');
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) { /* Safari */
            document.webkitExitFullscreen();
        }
    }
    
    fullscreenBtn.addEventListener('click', enterFullscreen);
    exitFullscreenBtn.addEventListener('click', exitFullscreen);
    
    document.addEventListener('fullscreenchange', () => {
        if (!document.fullscreenElement) {
            document.body.classList.remove('fullscreen');
        }
    });

</script>
</body>
</html>
