rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /artifacts/{appId}/public/data {

      function isAdmin(aId) {
        return request.auth != null &&
               request.auth.token.email != null &&
               get(/databases/$(database)/documents/artifacts/$(aId)/public/data/config/main).data.settings.admins.hasAny([request.auth.token.email]);
      }

      match /config/main {
        allow read: if request.auth != null;
        allow write: if isAdmin(appId);
      }

      match /queue/{docId} {
        allow read, create: if request.auth != null;
        allow update, delete: if isAdmin(appId);
      }

      match /votes/{voteId} {
        allow read: if request.auth != null;
        allow write: if isAdmin(appId);

        match /responses/{userId} {
          allow read: if request.auth != null;
          // Rozděleno pro maximální spolehlivost owner checku
          allow write: if request.auth != null && request.auth.uid == userId;
          allow write: if isAdmin(appId);
        }
      }

      match /history/{userId} {
        // Rozděleno pro maximální spolehlivost owner checku
        allow read, create, update: if request.auth != null && request.auth.uid == userId;
        allow read, write: if isAdmin(appId);
      }
    }
  }
}
