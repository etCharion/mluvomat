rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /artifacts/{appId}/public/data {

      function isAdmin(appId) {
        return request.auth != null &&
          get(/databases/$(database)/documents/artifacts/$(appId)/public/data/config/main).data.settings.admins.hasAny([request.auth.token.email]);
      }

      match /config/main {
        allow read: if request.auth != null;
        allow write: if isAdmin(appId);
      }

      match /queue/{doc=**} {
        allow read, create: if request.auth != null;
        allow update, delete: if isAdmin(appId);
      }

      match /votes/{voteId} {
        allow read: if request.auth != null;
        allow write: if isAdmin(appId);

        match /responses/{userId} {
          allow read: if request.auth != null;
          // Povoleno pro majitele hlasu NEBO administrátora (nutné pro reset/smazání hlasování)
          allow write: if request.auth != null && (request.auth.uid == userId || isAdmin(appId));
        }
      }

      match /history/{userId} {
        allow read: if isAdmin(appId) || (request.auth != null && request.auth.uid == userId);
        allow create, update: if isAdmin(appId) || (request.auth != null && request.auth.uid == userId);
        allow delete: if isAdmin(appId);
      }
    }
  }
}
