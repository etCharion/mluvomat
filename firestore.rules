rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function getAdmins(aId) {
      return exists(/databases/$(database)/documents/artifacts/$(aId)/public/data/config/main)
        ? get(/databases/$(database)/documents/artifacts/$(aId)/public/data/config/main).data.settings.admins
        : [];
    }

    function isAdmin(aId) {
      return request.auth != null
        && request.auth.token.get('email', '') in getAdmins(aId);
    }

    match /artifacts/{appId}/public/data {

      match /config/main {
        allow read: if request.auth != null;

        // Initialization
        allow create: if request.auth != null
          && !exists(/databases/$(database)/documents/artifacts/$(appId)/public/data/config/main);

        // Admin access
        allow update, delete: if isAdmin(appId);

        // Allow regular users to become the first speaker
        allow update: if request.auth != null
          && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['state'])
          && (!resource.data.keys().hasAll(['state']) || resource.data.state.get('currentSpeaker', null) == null || resource.data.state.get('currentSpeaker', '') == "");
      }

      match /queue/{doc=**} {
        allow read, create: if request.auth != null;
        allow update, delete: if isAdmin(appId);
      }

      match /votes/{voteId} {
        allow read: if request.auth != null
          && (isAdmin(appId) || resource.data.visible == true);

        allow write: if isAdmin(appId);

        match /responses/{userId} {
          allow read: if request.auth != null
            && (isAdmin(appId) || get(/databases/$(database)/documents/artifacts/$(appId)/public/data/votes/$(voteId)).data.visible == true);

          // Prioritize owner check, split from admin check
          allow write: if request.auth != null && request.auth.uid == userId;
          allow write: if isAdmin(appId);
        }
      }

      match /history/{userId} {
        // Prioritize owner check, split from admin check
        allow read, write: if request.auth != null && request.auth.uid == userId;
        allow read, write: if isAdmin(appId);
      }
    }
  }
}
