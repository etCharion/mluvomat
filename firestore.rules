rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /artifacts/{appId}/public/data {

      function isAdmin(aId) {
        return request.auth != null &&
          request.auth.token.get('email', '') in get(/databases/$(database)/documents/artifacts/$(aId)/public/data/config/main).data.settings.admins;
      }

      match /config/main {
        allow read: if request.auth != null;
        allow write: if isAdmin(appId);
      }

      match /queue/{doc=**} {
        allow read, create: if request.auth != null;
        allow update, delete: if isAdmin(appId);
      }

      match /votes/{voteId} {
        allow read: if request.auth != null;
        allow write: if isAdmin(appId);

        match /responses/{userId} {
          allow read: if request.auth != null;
          // Povoleno pro majitele hlasu NEBO administr√°tora
          allow write: if request.auth != null && (request.auth.uid == userId || isAdmin(appId));
        }
      }

      match /history/{userId} {
        allow read: if request.auth != null && (request.auth.uid == userId || isAdmin(appId));
        allow create, update: if request.auth != null && (request.auth.uid == userId || isAdmin(appId));
        allow delete: if isAdmin(appId);
      }
    }
  }
}
